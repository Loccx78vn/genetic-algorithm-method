{"title":"Genetic Algorithms in R","markdown":{"yaml":{"title":"Genetic Algorithms in R","subtitle":"Việt Nam, 2024","categories":["SupplyChainManagement","Logistics","Genetic Algorithm"],"description":"Đây là bài viết của tôi về cách sử dụng R trong ứng dụng Genetic Algorithm trong Supply Chain","number-sections":true,"format":{"html":{"code-fold":true,"code-tools":true}},"filters":["quarto-ext/shinylive"],"bibliography":"references.bib"},"headingText":"Giới thiệu:","containsRefs":false,"markdown":"\n\n\n```{r}\n#| warning: false\n#| message: false\n#| echo: false\n#Call packages\npacman::p_load(rio,\n               here,\n               janitor,\n               tidyverse,\n               dplyr,\n               magrittr,\n               ggplot2,\n               purrr,\n               lubridate,\n               mice,\n               plotly,\n               DiagrammeR,\n               shinylive)\n```\n\n## Vài điểm về thuật toán Genetic:\n\n**GA** hay **Genetic Algorithm** là 1 thuật toán tối ưu hóa ngẫu nhiên (**stochastic search algorithms**), được phát triển dựa trên lý thuyết tiến hóa và sự chọn lọc tự nhiên của sinh học [@lucascrucca2013].\n\nỞ thời cấp 3, bạn đã từng học về lý thuyết tiến hóa và chọn lọc tự nhiên của [Charles Darwin](https://vi.wikipedia.org/wiki/Charles_Darwin) và [Alfred Russel](https://vi.wikipedia.org/wiki/Alfred_Russel_Wallace) ở môn Sinh học. Nếu bạn cũng từng liệt Sinh như tôi thì bạn quên cũng không sao 😅😅. Vậy thì để tôi giải thích lại như sau:\n\nSự tiến hóa là sự thay đổi đặc điểm di truyền của 1 quần thể sinh vật, ví dụ điển hình chính là từ loại vượn đã tiến hóa thành hình dạng con người văn minh như các bạn bây giờ. Vậy quá trình tiến hóa đó diễn ra khi có sự chọn lọc tự nhiên tạo ra các biến dị di truyền (Ví dụ: đột biến,...) và kết quả là các cá thể đột biến trở nên phổ biến hơn hoặc hiếm gặp hơn trong quần thể. Vậy điều kiện để xảy ra sự chọn lọc tự nhiên có thể là sự thay đổi về môi trường sống, địa lý,... dẫn tới sự khác nhau về khả năng sống sót và sinh sản.\n\nKết cục là xuất hiện các cá thể đột biến \"mạnh mẽ hơn\" hoặc đúng là \"đặc biệt hơn\" có khả năng tồn tại khi xuất hiện sự thay đổi lớn, ví dụ như dưới đây, do sự thay đổi về địa điểm sống, từ một loại chim sẻ đã phát triển thành 3 phân họ khác nhau.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Natural_selection.jpg\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 1: Ví dụ về chọn lọc tự nhiên\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://www.biologyonline.com/dictionary/natural-selection\">Link to Image</a>\n  </div>\n</div>\n```\n\nVậy lí thuyết này liên quan gì tới vấn đề tối ưu hóa. Thông thường khi bạn muốn tối ưu hóa một vấn đề gì đó, bạn cần xây dựng mô hình định lượng nó, ví dụ như dưới ảnh này ta đang có mô hình [MILP](https://www.mathworks.com/help/optim/ug/mixed-integer-linear-programming-algorithms.html) nhằm hoạch định tuyến đường và tối ưu hóa quãng đường di chuyển.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/MILP.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 2: Mô hình VRP\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://medium.com/@rihot_gusron/capacitated-vehicle-routing-problem-with-lingo-427c2d3bf724\">Link to Image</a>\n  </div>\n</div>\n```\n\nMục tiêu của hàm chính là tìm ra giá trị nhỏ nhất nghĩa là chi phí cho việc di chuyển của xe là nhỏ nhất. Do đó, bạn có thể hình dung rằng **giá trị nhỏ nhất** đó như là các **cá thể đột biến** có khả năng sống sót cao nhất trong quẩn thể.\n\nVì vậy thuật toán **Genetic** (GA) chính là lặp đi lặp lại sự chọn lọc tự nhiên trong một quần thể hoặc một mẫu để đến cuối cùng tìm ra cá thể vượt trội nhất.\n\n## Cách hoạt động GA trong ML:\n\nTrong Machine Learning, GA nhằm tìm ra đúng các biến cần thiết để xây dựng mô hình tốt nhất. Gỉa sử chúng ta có 2 mô hình là:\n\n-   Mô hình 1: gồm các biến A,C,D.\n-   Mô hình 2: gồm biến A,B,E.\n\nVậy mô hình nào mới là tốt nhất cho mô hình dự đoán ? Chúng ta chưa biết được và chỉ có thể so sánh nó thông qua thuật toán Genetic.\n\nVề quy trình, thuật toán Genetic sẽ có cách hoạt động như dưới đây. Quy trình này mình tham khảo của [@rohithgandhi2018].\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Genetic_Algorithm.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 3: Thuật toán Genetic\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://medium.datadriveninvestor.com/genetic-algorithms-9f920939f7cc\">Link to Image</a>\n  </div>\n</div>\n```\n\nDiễn giải cách hoạt động:\n\n-   Bước 1 (**Initialisation**): mỗi biến được xem là *Gene* và nhiều *Gene* gộp lại thành một mô hình hay gọi là *Chromosome* và nhiều *Chromosome* sẽ tạo thành một quần thể (*Population*). Việc này giống như là bạn đang trình bày hết các phương án có thể sử dụng.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Term.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 4: Các thuật ngữ trong GA\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://www.doc.ic.ac.uk/research/technicalreports/2003/DTR03-4.pdf\">Link to Image</a>\n  </div>\n</div>\n```\n\n-   Bước 2 (**Fitness Function**): Bạn cần xây dựng một hàm mục tiêu để tính toán giá trị cho các mô hình ở bước 1.\n\n-   Bước 3 (**Selection**): Biến nào có giá trị yếu kém sẽ bị loại và quá trình tính toán sẽ tiếp tục ở thế hệ của nó tiếp theo. Diễn giải đơn giản hơn là chúng ta thử một cách khác và cố gắng cải thiện kết quả.\n\n-   Bước 4 (**Crossover**): Tạo ra mô hình gồm các biến tốt đã lựa chọn ở bước 3. Ví dụ như biến A, B là tốt cho mô hình.\n\n-   Bước 5 (**Mutation**): Thay đổi mô hình đầu vào đã bao gồm các biến ở bước 4 và bắt đầu lại từ bước 1. Ví dụ mô hình cần chọn gồm 5 biến và ta đã chọn được biến A,B là tốt. Do đó, khi quay lại bước 1, ta chỉ cần chọn thêm 3 biến thay vì 5 biến như thông thường.\n\n# Thực hành trong R:\n\nSau khi đã sơ lược về thuật toán, bây giờ ta sẽ vào phần thực hành trong R. Vậy làm sao để ứng dụng thuật toán Genetic trong R, mình đã kham khảo qua nhiều nguồn tài liệu và tổng hợp dưới đây:\n\n**Xây dựng hàm mục tiêu**: hàm mục tiêu là bước quan trọng nhất trong thuật toán Genetic vì nó là cơ sở để đánh giá và lựa chọn cá thể vượt trội nhất. Và hàm mục tiêu sẽ luôn khác nhau tùy vào vấn đề mà ta đặt ra. Giả sử chúng ta muốn tối ưu chi phí thì nó là hàm Min, còn ta muốn tối đa lợi nhuận thì nó sẽ là hàm Max.\n\nVậy hàm mục tiêu của bài toán trên trong R, bạn có thể tham khảo phần code bên dưới mình:\n\n::: callout-important\n### Type of fitness function\n\nĐối số `type` trong hàm có 3 giá trị:\n\n-   `\"binary\"`: đại diện cho biến quyết định dạng phân loại, ví dụ: có/không\n-   `\"real-valued\"`: dùng dể tối ưu cho các biến quyết định là dạng số thực, số tự nhiên.\n-   `\"permutation\"`: cho các vấn đề liên quan đến việc sắp xếp lại các biến thành danh sách, ví dụ: thang đo Likert.\n:::\n\nChi tiết về hàm `ga()`, bạn có thể tham khảo tài liệu của [@lucascrucca2013].\n\n## Thuật toán Genetic:\n\nVậy bây giờ chúng ta sẽ xử lí bài toán trên theo thuật toán **Genetic**\n\nGỉa sử chúng ta có bài toán về vận chuyển hàng từ nhà kho để thỏa mãn nhu cầu ở các điểm **DC (Distribution center)**. Và công thức để tính toán được chi phí là:\n\nHàm chi phí tổng thể được xác định như sau:\n\n$$\nTC = \\sum_{i=1}^{m} \\left( D_{ij} \\times \\frac{P}{F} \\times 0.4 + LC_i \\right) \\times Q_j\n$$\n\nTrong bài toán này, bạn sẽ cần dữ liệu để tính toán 2 thông số là: **Phí bốc xếp (Loading cost)** và **Chi phí vận chuyển (Transportation cost)**.\n\nNếu trong công việc thường ngày ở công ty, chúng ta sẽ cần lấy dữ liệu từ **Data warehouse** bằng SQL hoặc các phần mềm **Business Intelligence** khác. Ở đây, nhằm mục đích học tập, mình đã tạo ra code ở phía dưới để xây dựng dữ liệu cho các bạn luyện tập.\n\n```{r}\n# Create a data frame for loading costs\nloading_costs <- data.frame(\n  Warehouse = rep(paste(\"WH\", 1:5), each = 4),\n  ID = rep(1:5, times = 4),\n  Weight_Category = rep(c(\"< 2 tons\", \"2 to 5 tons\", \"5 to 10 tons\", \"> 10 tons\"), times = 5),\n  Has_Machine = rep(c(\"Yes\", \"No\", \"Yes\", \"No\", \"No\"), each = 4),\n  Loading_Cost = c(80, 100, 120, 160,  # Warehouse 1 (with machine)\n                   110, 150, 180, 210,  # Warehouse 2 (without machine)\n                   85, 105, 125, 140,  # Warehouse 3 (with machine)\n                   150, 170, 190, 210,  # Warehouse 4 (without machine)\n                   140, 165, 185, 215)   # Warehouse 5 (without machine)\n)\n\n# Set seed for reproducibility\nset.seed(123)\n\n# Define parameters\nweight_categories <- c(\"< 1.5\", \"1.5 to 2.5\", \"2.5 to 5\", \"5 to 10\", \"> 10\")\n# Create the data frame\nloading_costs <- data.frame(\n  Warehouse = rep(1:5, each = 15),  # 5 warehouses, 15 rows each\n  DC = rep(rep(1:3, each = 5), times = 5),  # Repeat 1, 2, 3 for each warehouse\n  Weight_Category = rep(weight_categories, times = 15),  # Repeat categories for 15 rows\n  Loading_Cost = round(runif(75, 5, 150), 2),\n  Has_Machine = sample(c(\"Yes\", \"No\"), 75, replace = TRUE)\n)\n\n# Define warehouses with coordinates (latitude, longitude)\nwarehouses <- data.frame(\n  ID = 1:5,\n  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060), # Example latitudes (Hanoi, HCMC, Da Nang, etc.)\n  Longitude = c(105.804, 108.2022, 106.6957, 108.2772, 105.7460) # Example longitudes\n)\n\n# Define distribution centers data in Vietnam (example coordinates)\ndistribution_centers <- data.frame(\n  ID = 1:3,\n  Demand = c(90, 30, 150),\n  Latitude = c(17.974855, 11.7769, 15.122327), # Example latitudes (Hanoi, Da Nang, HCMC)\n  Longitude = c(102.630867, 106.6957, 108.799357) # Example longitudes\n)\n```\n\nNếu bạn từng gặp khó khăn trong việc phải đối mặt với cả đống dữ liệu từ hệ thống và chưa biết lấy dữ liệu nào để phân tích hoặc gộp bảng nào qua bảng nào thì lời khuyên của mình là hãy vẽ bảng **Entity relation diagram (ERD)**.\n\n**ERD** là một công cụ trực quan dùng để mô tả cấu trúc dữ liệu trong cơ sở dữ liệu. ERD thể hiện các thực thể (*entities*), thuộc tính (*attributes*), và các mối quan hệ (*relationships*) giữa chúng. Các thực thể thường được biểu diễn dưới dạng hình chữ nhật, thuộc tính dưới dạng hình ellips, và mối quan hệ bằng hình thoi hoặc đường nối. ERD giúp lập kế hoạch cho thiết kế cơ sở dữ liệu, đảm bảo rằng các yếu tố dữ liệu và quan hệ giữa chúng được xác định rõ ràng, tạo nền tảng cho việc phát triển và quản lý dữ liệu hiệu quả.\n\nNhư biểu đồ dưới đây, mình đang có 3 bảng gồm:\n\n-   Bảng thông tin chi tiết về DC.\n\n-   Bảng thông tin chi tiết về WH.\n\n-   Bảng giá về loading cost và transportation cost từ WH đến DC.\n\nVà các bạn có thể dễ dàng hình dung các mối quan hệ thông qua bảng **Entity relation diagram (ERD)** dưới đây:\n\n```{r}\n#| echo: false\n#| fig-subcap: \"Biểu đồ 1: EDR model\"\nlibrary(datamodelr)\n# Create the data model from your data frames\ndm1 <- dm_from_data_frames(list(\n  Warehouses = warehouses,\n  Loading_Costs = loading_costs,\n  Distribution_Centers = distribution_centers\n)) %>%\n  dm_set_key(\"Warehouses\", \"ID\") %>%\n  dm_set_key(\"Loading_Costs\", c(\"Warehouse\", \"DC\")) %>%\n  dm_set_key(\"Distribution_Centers\", \"ID\") %>%\n  dm_add_references(\n    Loading_Costs$Warehouse == Warehouses$ID,  # Correct reference\n    Loading_Costs$DC == Distribution_Centers$ID  # Assuming this is the correct reference\n  )\n\n# Create and render the ERD\ndm_create_graph(dm1, rankdir = \"LR\", columnArrows = TRUE) %>%\n  dm_render_graph()\n```\n\n::: callout-tip\n### Tải package datamodelr:\n\nMình tạo biểu đồ này bằng thư viện `datamodelr`. Bạn có thể tải bằng cú pháp: `devtools::install_github(\"bergant/datamodelr\")`\n:::\n\n### Dữ liệu đầu vào:\n\nNhư vậy, dựa vào đó, ta sẽ tính toán được 2 *matrix* về chi phí:\n\n-   Bảng giá loading ở các kho. (Hình bên trái)\n\n-   Bảng chi phí vận chuyển từ từng WH đến các DCs. (Hình bên phải)\n\n```{r}\n#| warning: false\n#| message: false\n## Calculate the transportation cost:\n# Haversine distance function\nhaversine <- function(lat1, lon1, lat2, lon2) {\n  R <- 6371 # Radius of Earth in kilometers\n  dlat <- (lat2 - lat1) * pi / 180\n  dlon <- (lon2 - lon1) * pi / 180\n  a <- sin(dlat / 2) * sin(dlat / 2) +\n       cos(lat1 * pi / 180) * cos(lat2 * pi / 180) * \n       sin(dlon / 2) * sin(dlon / 2)\n  c <- 2 * atan2(sqrt(a), sqrt(1 - a))\n  R * c # Distance in kilometers\n}\n\n# Calculate distance matrix based on coordinates\ndistance_matrix <- matrix(0, nrow = nrow(warehouses), ncol = nrow(distribution_centers))\n\nfor (i in 1:nrow(warehouses)) {\n  for (j in 1:nrow(distribution_centers)) {\n    distance_matrix[i, j] <- haversine(\n      warehouses$Latitude[i], warehouses$Longitude[i],\n      distribution_centers$Latitude[j], distribution_centers$Longitude[j]\n    )\n  }\n}\n\n# Define the fuel price (example value)\nfuel_price <- 20 # Fuel price per kilometer\n\n# Calculate transportation costs\ntransportation_costs <- distance_matrix * fuel_price * 0.4\n\n## Calculate the loading cost:\nweights_per_good <- 0.1\n\nmean_loading_cost<-loading_costs %>% \n  group_by(DC, Warehouse) %>% \n  summarise(mean = mean(Loading_Cost,na.rm = TRUE)/1000/weights_per_good) %>% # Assumes weighted of goods is 0.1kg \n  ungroup()\n\nlibrary(data.table)\n# Reshape the data frame to a wide format\nmean_cost_matrix <- reshape2::dcast(mean_loading_cost,\n                          Warehouse ~ DC, \n                          value.var = \"mean\")\n\n# Convert the data frame to a matrix and remove the Warehouse column\nloading_costs_per_dc <- as.matrix(mean_cost_matrix[,-1])\n\n# Set row names as the warehouse names\nrownames(loading_costs_per_dc) <- mean_loading_cost$Warehouse[!duplicated(mean_loading_cost$Warehouse)]\n```\n\n```{r}\n#| warning: false\n#| message: false\n#| echo: false\n#| fig-cap: \"Tổng các phi phí cho việc bốc xếp và vận chuyển hàng hóa\"\n#| fig-subcap: [\"Biểu đồ 2: Heatmap cho bảng chi phí bốc xếp\", \"Biểu đồ 3: Bảng giá vận chuyển từ WH đến DC\"]\n#| layout-ncol: 2\n# Code tạo hai biểu đồ\n\nlibrary(ggplot2)\n\n# Convert the distance matrix to a data frame\ndistance_df <- reshape2::melt(transportation_costs)\ncolnames(distance_df) <- c(\"Warehouse\", \"Distribution_Center\", \"Transportation_Cost\")\n\n# Plot the distance matrix with updated colors\nggplot(distance_df, aes(x = Warehouse, \n                        y = Distribution_Center, \n                        fill = Transportation_Cost)) +\n  geom_tile(color = \"white\", linewidth = 0.5) +  # Add borders to tiles\n  geom_text(aes(label = scales::comma(Transportation_Cost, accuracy = 1)), \n            color = ifelse(distance_df$Transportation_Cost > \n                           max(distance_df$Transportation_Cost)/2, \"white\", \"black\"),\n            size = 3.5) +  # Adaptive text color\n  scale_fill_gradient2(\n    low = \"#f7fbff\", \n    mid = \"#6baed6\", \n    high = \"#08519c\",\n    midpoint = median(distance_df$Transportation_Cost),\n    name = \"Cost (VNĐ)\",\n    labels = scales::comma\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Transportation Costs Between Facilities\",\n    subtitle = \"Costs shown in Vietnamese Dong (VNĐ)\",\n    x = \"Warehouse\",\n    y = \"Distribution Center\"\n  ) +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1, face = \"bold\", size = 12),\n    axis.text.y = element_text(face = \"bold\", size = 12),\n    axis.title.x = element_text(size = 14, face = \"bold\", margin = margin(t = 15)),\n    axis.title.y = element_text(size = 14, face = \"bold\", margin = margin(r = 15)),\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12, color = \"gray30\"),\n    panel.grid = element_blank(),  # Remove grid lines\n    legend.position = \"right\"\n  )\n\n# Convert the transportation costs matrix to a data frame\nlibrary(gt)\nlibrary(gtExtras)\n# Create a gt table\nm<-loading_costs %>%\n  mutate(Loading_Cost = Loading_Cost * 1000,\n         DC = paste(\"DC\",DC),\n         Warehouse = paste(\"WH\",Warehouse)) # Convert to currency\n  \nhead(m[order(-m$Loading_Cost),]) %>% \n  gt() %>%\n  fmt_currency(\n    columns = Loading_Cost,\n    currency = \"VND\",\n    decimals = 0,\n    use_seps = TRUE\n  ) %>%\n  tab_header(\n    title = md(\"**Loading Costs by weight category in each warehouses**\"),\n    subtitle = md(\"Table just contains **expected loading cost**\")\n  ) %>%  \n  opt_align_table_header(align = \"center\") %>% \n  cols_label(\n    Loading_Cost = \"Loading Cost (VNĐ)\",\n    Weight_Category = \"Weight Category\",\n    Has_Machine = \"Has Machine\",\n    DC = \"Distribution Center\"\n  ) %>% \n  data_color(method = \"numeric\",\n             palette = \"viridis\",\n             reverse = TRUE) %>% \n  gt_theme_pff() %>% \n  tab_style(style = list(cell_text(align = \"center\")),\n            locations = cells_body(columns = everything())) %>%\n  tab_style(\n    style = list(\n      cell_text(align = \"center\")\n    ),\n    locations = list(\n      cells_column_labels(everything())\n    )\n  ) %>% \n  tab_source_note(source = md(\"*Source: package gt in R*\")) %>% \n  tab_style(\n    style = \"font-weight: bold\",\n    locations = cells_body(Weight_Category)\n  )\n  \n```\n\n### Xây dựng hàm mục tiêu:\n\nSau khi đã có đủ dữ liệu, bạn sẽ bắt đầu viết hàm mục tiêu và dùng thuật toán GA để tìm ra giá trị tối ưu nhất.\n\nTrong hàm `ga` từ gói **GA** trong R, có một số đối số quan trọng cho phép bạn tùy chỉnh thuật toán di truyền. Dưới đây là một cái nhìn tổng quan về một số đối số quan trọng:\n\n-   **type**: Chỉ định loại tối ưu hóa (ví dụ: `\"real-valued\"`, `\"binary\"` hoặc `\"permutation\"`).\n\n-   **fitness**: Hàm đánh giá độ phù hợp; nó nên nhận một vector tham số làm đầu vào và trả về một giá trị số.\n\n-   **lower** và **upper**: Định nghĩa giới hạn cho các biến nếu bạn đang tối ưu hóa trong không gian liên tục (dùng cho các loại giá trị thực).\n\n-   **popSize**: Thiết lập kích thước quần thể cho mỗi thế hệ.\n\n-   **maxiter**: Chỉ định số thế hệ tối đa để chạy thuật toán.\n\n-   **run**: Chỉ định số thế hệ để chạy thuật toán mà không có sự cải thiện trước khi dừng lại.\n\n-   **pmutation**: Xác suất xảy ra đột biến trong quần thể.\n\n-   **elitism**: Xác định xem các cá thể tốt nhất có nên được giữ lại trong thế hệ tiếp theo hay không.\n\nNhững đối số này giúp điều chỉnh thuật toán di truyền cho các nhu cầu tối ưu hóa cụ thể của bạn, cho phép hiệu suất tốt hơn và hội tụ về các giải pháp tối ưu.\n\nNgoài ra, còn có các lưu ý cho bạn khi sử dụng R như sau:\n\n::: callout-caution\n### Lưu ý khi dùng hàm ga():\n\nHàm `ga()` phải có ít nhất 2 đối số là `type` và `fitness thì R mới chạy được.`\n\n-   Riêng khi type = \"binary\" thì cần thêm đối số `nBits.`\n\n-   Còn khi `type = \"real-valued\"/\"permutation\"` thì cần thêm đối số `min` và `max`.\n:::\n\n```{r}\n#| message: false\n#| warning: false\n#| output: false\n# Load necessary library\nlibrary(GA)\ndemand<-c(distribution_centers$Demand)\n\n# Define the objective function\nobjective_function <- function(quantities) {\n    quantities_matrix <- matrix(quantities, \n                                nrow = 5, \n                                ncol = 3, \n                                byrow = TRUE)\n    \n    # Calculate total loading costs\n    loading_costs <- rowSums(quantities_matrix) * loading_costs_per_dc  # Total loading costs for each DC\n    # Calculate total transportation costs\n    transportation_costs <- sum(quantities_matrix * transportation_costs)\n    \n    # Combine both costs\n    total_cost <- sum(loading_costs) + transportation_costs\n    \n    # Check if demands are met\n    if (any(colSums(quantities_matrix) < demand)) {\n        return(Inf)  # Penalize if demands are not met\n    }\n    \n    return(total_cost)\n}\n\n# Set up the Genetic Algorithm\nnum_vars <- 5 * 3  # 5 warehouses, 3 distribution centers\nga_result <- ga(\n    type = \"real-valued\",\n    fitness = function(x) -objective_function(x),  # Negate for minimization\n    lower = rep(0, num_vars),  # Minimum quantity\n    upper = rep(100, num_vars),  # Maximum quantity (adjust as needed)\n    popSize = 50,\n    maxiter = 100,\n    run = 10,\n    monitor = TRUE\n)\n```\n\n```{r}\n#| echo: false\n#| warning: false\n#| message: false\nlibrary(leaflet)\n## Update flag of countries in each locations:\nlibrary(readxl)\nwrite <- read_excel(\"write.xlsx\")\nwarehouses<-write[1:5,]\ndistribution_centers<-write[6:8,]\n```\n\n```{r}\n#| warning: false\n#| message: false\n# Assuming ga_result@solution contains optimal quantities\nga_result_solution <- c(ga_result@solution)\n\n# Reshape the solution into a matrix (5 warehouses x 3 DCs)\noptimal_quantities <- matrix(ga_result@solution,\n                             nrow = 5, \n                             ncol = 3, \n                             byrow = TRUE)\n\n# Convert the matrix to a data frame\nweights<-optimal_quantities* weights_per_good\n\nrownames(weights) <- 1:5\ncolnames(weights) <- 1:3\n\nlibrary(reshape2)\nreal_weighted <- melt(weights)\n\n# Rename the columns\ncolnames(real_weighted) <- c(\"Warehouse\", \"DC\", \"Total_Weight\")\n\n# Perform left join\nresult <- real_weighted %>%\n  left_join(loading_costs, by = c(\"Warehouse\", \"DC\"))\n\nresult <-result %>% \n  mutate(Price = case_when(\n    Total_Weight < 1.5 ~ \"< 1.5\",\n    Total_Weight <2.5 ~ \"1.5 to 2.5\",\n    Total_Weight < 5 ~ \"2.5 to 5\",\n    Total_Weight < 10 ~ \"5 to 10\",\n    Total_Weight >= 10 ~ \"> 10\",\n      is.na(Total_Weight) ~ NA_character_  # Handle NA explicitly if needed\n  ))\n  \nresult<-result %>% \n  filter(Weight_Category == Price) %>% \n  select(-Price)\n\n# Join with tranportation cost table:\nrownames(transportation_costs) <- 1:5\ncolnames(transportation_costs) <- 1:3\n\ntransport<-melt(transportation_costs)\n\n# Rename the columns\ncolnames(transport) <- c(\"Warehouse\", \"DC\", \"Transport_cost\")\n\n\nresult<-left_join(result,\n                  transport,\n                  by=c(\"Warehouse\", \"DC\"))\n\n# Adjust:\n\nresult<-result %>% \n      mutate(Loading_Cost = Loading_Cost*1000,\n             Transport_cost = Transport_cost*1000,\n             DC = paste(\"DC\",DC),\n             Warehouse = paste(\"WH\",Warehouse)) \n\n# Reorder cols in table:\nresult<-result[,c(\"Warehouse\",\n                 \"DC\",\n                 \"Has_Machine\",\n                 \"Total_Weight\",\n                 \"Weight_Category\",\n                 \"Loading_Cost\",\n                 \"Transport_cost\")]\n```\n\n### Báo cáo:\n\nVà cuối cùng, sau khi có kết quả, mình sẽ dùng các thư viện gồm: **Leaflet**, **gt**, và **biểu đồ Sankey** phục vụ những mục đích khác nhau cho trực quan hóa dữ liệu.\n\n1.  **Leaflet**: Đây là một thư viện mạnh mẽ để tạo bản đồ tương tác. Nó cho phép người dùng dễ dàng thêm các lớp, điểm đánh dấu và pop-up, rất lý tưởng để trực quan hóa dữ liệu địa lý. Leaflet đặc biệt hữu ích để hiển thị các dữ liệu như vị trí, lộ trình, hoặc phân bố không gian.\n\n2.  **gt**: Gói **gt** được thiết kế để tạo ra các bảng chất lượng cao trong R. Nó cho phép người dùng định dạng và tạo kiểu cho bảng một cách dễ dàng, giúp chúng trở nên hấp dẫn và dễ đọc. gt hỗ trợ các tính năng như định dạng tùy chỉnh, dòng tóm tắt, và thậm chí thêm chú thích, nâng cao cách trình bày dữ liệu trong báo cáo.\n\n3.  **Biểu đồ Sankey**: Những biểu đồ này được sử dụng để trực quan hóa luồng và mối quan hệ giữa các danh mục khác nhau. Trong R, gói **networkD3** hoặc **ggalluvial** có thể tạo ra biểu đồ Sankey, giúp hiểu cách các giá trị di chuyển giữa các nút, chẳng hạn như theo dõi hành trình người dùng hoặc hiển thị phân bổ tài nguyên.\n\nĐể kết nối các biểu đồ lại với nhau, ta thường nghĩ đến `Shiny` trong **R** nhưng vì chúng ta đang tạo website bằng **Quarto** nên output cuối cùng sẽ là một trang web tĩnh - *static website*. Do đó, nó sẽ không phản hồi với thông tin đầu vào của người dùng hoặc chạy bất kỳ mã R nào. Bạn có thể hình dung giống như bạn đang muốn xem biểu đồ về doanh thu trong tháng tiếp theo trên 1 biểu đồ trong Word - không thể làm được vì nó thuộc dạng văn bản, bạn chỉ đọc hoặc nhìn chứ không tương tác được.\n\nTuy vậy, sau một thời gian tìm hiểu, mình cũng tìm được cách để nhúng **Shiny** vào R để hiển thị trên Quarto. Nguồn tài liệu bạn có thể kham khảo ở trang này [r-shinylive-demo](https://github.com/coatless-quarto/r-shinylive-demo).\n\n:::{.column-page}\n\n```{shinylive-r}\n#| viewerHeight: 1000\n#| standalone: true\n#| fig-cap: \"Biểu đồ 3: Dashboard về lịch trình vận chuyển hàng dự tính\"\npacman::p_load(\n  leaflet,\n  dplyr,\n  networkD3,\n  shiny,\n  bslib,\n  DT,\n  htmltools\n)\n\n# Add value:\n# Convert GA solution to a matrix\n# Optimal quantities matrix\noptimal_quantities <- matrix(c(\n  43.306058, 10.87137, 13.26283,\n  15.524054, 30.42748, 48.86716,\n  7.599769, 44.93531, 27.46289,\n  18.556927, 17.60396, 41.85203,\n  16.305016, 13.15498, 21.79634\n), nrow = 5, ncol = 3, byrow = TRUE)\n\n# Warehouse data:\nwarehouses <- data.frame(\n  ID = 1:5,\n  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060),\n  Longitude = c(105.8040, 108.2022, 106.6957, 108.2772, 105.7460),\n  District = c(\"Đống Đa\", \"Hải Châu\", \"Quận 1\", \"Mang Yang\", \"Đông Sơn\"),\n  Province = c(\"Hà Nội\", \"Đà Nẵng\", \"Hồ Chí Minh\", \"Gia Lai\", \"Thanh Hóa\"),\n  Address = c(\n    \"2RH3+9HX Đống Đa, Hà Nội, Việt Nam\",\n    \"3632+RV4 Hải Châu, Đà Nẵng, Việt Nam\",\n    \"QMGW+Q74 Quận 1, Hồ Chí Minh, Việt Nam\",\n    \"375G+8VG Mang Yang, Gia Lai, Việt Nam\",\n    \"RP4W+99X Đông Sơn, Thanh Hóa, Việt Nam\"\n  )\n)\n\n# Distribution center data:\ndistribution_centers <- data.frame(\n  ID = 1:3,\n  Latitude = c(17.97486, 11.77690, 15.12233),\n  Longitude = c(102.6309, 106.6957, 108.7994),\n  District = c(\"Viêng Chăn\", \"Lộc Ninh\", \"Quảng Ngãi\"),\n  Province = c(\"Lào\", \"Bình Phước\", \"Quảng Ngãi\"),\n  Address = c(\n    \"XJFJ+W8X Viêng Chăn, Lào\",\n    \"QMGW+Q74 Lộc Ninh, Bình Phước, Việt Nam\",\n    \"4QCX+WPQ Quảng Ngãi, Việt Nam\"\n  )\n)\n\n# Create a data frame with the warehouse data\nresult <- data.frame(\n  Warehouse = c(\"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\",\n                \"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\",\n                \"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\"),\n  DC = c(\"DC 1\", \"DC 1\", \"DC 1\", \"DC 1\", \"DC 1\",\n         \"DC 2\", \"DC 2\", \"DC 2\", \"DC 2\", \"DC 2\",\n         \"DC 3\", \"DC 3\", \"DC 3\", \"DC 3\", \"DC 3\"),\n  Has_Machine = c(\"Yes\", \"No\", \"No\", \"No\", \"No\",\n                  \"No\", \"No\", \"No\", \"No\", \"No\",\n                  \"No\", \"No\", \"No\", \"No\", \"No\"),\n  Total_Weight = c(4.3306058, 1.5524054, 0.7599769, 1.8556927, 1.6305016,\n                   1.0871366, 3.0427479, 4.4935308, 1.7603961, 1.3154977,\n                   1.3262832, 4.8867159, 2.7462887, 4.1852028, 2.1796338),\n  Weight_Category = c(\"2.5 to 5\", \"1.5 to 2.5\", \"< 1.5\", \"1.5 to 2.5\", \"1.5 to 2.5\",\n                      \"< 1.5\", \"2.5 to 5\", \"2.5 to 5\", \"1.5 to 2.5\", \"< 1.5\",\n                      \"< 1.5\", \"2.5 to 5\", \"2.5 to 5\", \"2.5 to 5\", \"1.5 to 2.5\"),\n  Loading_Cost = c(64300, 40680, 144640, 38790, 18750,\n                   11610, 97870, 36380, 69120, 70030,\n                   143740, 91150, 64990, 114230, 96240),\n  Transport_cost = c(3802097.2, 5037171.3, 7297102.2, 5952559.7, 3086494.5,\n                     8264855.3, 4021256.9, 889559.4, 2449208.3, 7188382.3,\n                     5831987.6, 974375.3, 4273915.6, 1047828.2, 4905804.6)\n)\n\n# Custom icon:\nwarehouse_icon <- makeIcon(\n  iconUrl = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/warehouse_icon.png\",\n  iconWidth = 30,\n  iconHeight = 30\n)\n\ndc_icon <- makeIcon(\n  iconUrl = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/distribution_center.png\",\n  iconWidth = 30,\n  iconHeight = 30\n)\n# Define a custom theme\nmy_theme <- bs_theme(\n  version = 5,\n  bootswatch = \"litera\",\n  primary = \"#3b5998\",\n  secondary = \"#5cb85c\",\n  success = \"#5cb85c\",\n  info = \"#5bc0de\",\n  warning = \"#f0ad4e\",\n  danger = \"#d9534f\"\n)\n\n# Define UI\nui <- page_fluid(\n  theme = my_theme,\n  \n  # Custom CSS for better visualization\n  tags$head(\n    tags$style(HTML(\"\n      .card-header {\n        background-color: #3b5998;\n        color: white;\n        font-weight: bold;\n      }\n      .nav-tabs .nav-link.active {\n        font-weight: bold;\n        color: #3b5998;\n        border-bottom: 2px solid #3b5998;\n      }\n      .nav-tabs .nav-link {\n        color: #6c757d;\n      }\n      .checkbox span {\n        font-weight: normal;\n      }\n      .checkbox input:checked + span {\n        font-weight: bold;\n        color: #3b5998;\n      }\n      .warehouse-selection {\n        border-left: 4px solid #3b5998;\n        padding-left: 10px;\n      }\n      .dataTables_wrapper {\n        padding: 10px;\n        border-radius: 5px;\n      }\n      .table thead th {\n        background-color: #e9ecef;\n      }\n      .leaflet-container {\n        border-radius: 8px;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n      }\n      .sankey-container {\n        border: 1px solid #dee2e6;\n        border-radius: 8px;\n        padding: 10px;\n        background-color: #f8f9fa;\n      }\n      .summary-stats {\n        background-color: #f8f9fa;\n        border-radius: 5px;\n        padding: 10px;\n        margin-bottom: 15px;\n        border-left: 4px solid #3b5998;\n      }\n    \"))\n  ),\n  \n  # Page header - simplified\n  card(\n    card_header(\n      tags$div(\n        class = \"d-flex align-items-center\",\n        tags$img(\n          src = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/warehouse_icon.png\", \n          height = \"30px\", \n          style = \"margin-right: 10px;\"\n        ),\n        h3(\"Warehouse Distribution Dashboard\", class = \"m-0\")\n      )\n    ),\n    card_body(\n      \"This dashboard shows the optimal distribution of goods from warehouses to distribution centers.\"\n    )\n  ),\n  \n  layout_sidebar(\n    sidebar = sidebar(\n      title = \"Controls\",\n      width = 300,\n      bg = \"#f8f9fa\",\n      class = \"warehouse-selection\",\n      \n      h4(\"Warehouse Selection\", class = \"mb-3 text-primary\"),\n      \n      p(\"Select one or more warehouses to view their distribution data on the map and in the charts.\"),\n      \n      checkboxGroupInput(\n        inputId = \"warehouse\", \n        label = NULL, \n        choices = setNames(\n          paste(\"Warehouse\", 1:5),\n          paste(\"Warehouse\", 1:5, \"-\", warehouses$District, \",\", warehouses$Province)\n        ),\n        selected = paste(\"Warehouse\", 1)\n      ),\n      \n      hr(),\n      \n      tags$div(\n        class = \"alert alert-info\",\n        icon(\"info-circle\"), \n        \"Click on the map markers for detailed location information.\"\n      )\n    ),\n    \n    # Main content - restructured to put summary above map\n    tabsetPanel(\n      tabPanel(\n        title = \"Interactive Map\", \n        icon = icon(\"map\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased height\n          card_body(\n            # Summary stats placed above the map\n            tags$div(\n              class = \"summary-stats\",\n              uiOutput(\"summary_stats\")\n            ),\n            # Map with increased height\n            leafletOutput(\"map\", height = \"550px\") # Increased map height\n          )\n        )\n      ),\n      \n      tabPanel(\n        title = \"Cost Analysis\", \n        icon = icon(\"table\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased to match\n          card_header(\"Cost Table\"),\n          DTOutput(\"cost_table\")\n        )\n      ),\n      \n      tabPanel(\n        title = \"Flow Diagram\", \n        icon = icon(\"diagram-project\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased to match\n          card_header(\"Distribution Flow Diagram\"),\n          tags$div(\n            class = \"sankey-container\",\n            uiOutput(\"sankey_diagram\")\n          )\n        )\n      )\n    )\n  )\n)\n\n# Define server logic\nserver <- function(input, output, session) {\n  \n  location <- reactive({\n    req(input$warehouse) \n    as.numeric(sub(\"Warehouse \", \"\", input$warehouse))\n  })\n  \n  # Create the leaflet map\n  output$map <- renderLeaflet({\n    req(location())\n    \n    # Color palette for routes\n    route_colors <- c(\"#FF5733\", \"#33A8FF\", \"#33FF57\", \"#D433FF\", \"#FFD133\")\n    \n    # Initialize the map\n    map <- leaflet() %>%\n      addTiles() %>%\n      addProviderTiles(providers$CartoDB.Positron) %>%\n      addMarkers(data = warehouses %>% filter(ID %in% location()), \n                 lat = ~Latitude, \n                 lng = ~Longitude, \n                 label = ~paste0(\"<strong> ID Warehouse: </strong> \", ID, \"<br/> \",\n                                 \"<strong> Province: </strong> \", Province, \"<br/> \",\n                                 \"<strong> District: </strong> \", District, \"<br/> \",\n                                 \"<strong> Address: </strong> \", Address, \"<br/> \") %>% \n                   lapply(htmltools::HTML),\n                 icon = warehouse_icon) %>%\n      addMarkers(data = distribution_centers, \n                 lat = ~Latitude, \n                 lng = ~Longitude, \n                 label = ~paste0(\"<strong> ID Distribution Center: </strong> \", ID, \"<br/> \",\n                                 \"<strong> Province: </strong> \", Province, \"<br/> \",\n                                 \"<strong> District: </strong> \", District, \"<br/> \",\n                                 \"<strong> Address: </strong> \", Address, \"<br/> \") %>% \n                   lapply(htmltools::HTML),\n                 icon = dc_icon)\n    \n    qty_data <- optimal_quantities[location(), , drop = FALSE]  \n    \n    # Add routes based on the optimal quantities with different colors\n    route_colors <- c(\"#FF5733\", \"#33A8FF\", \"#33FF57\", \"#D433FF\", \"#FFD133\")\n    line_weights <- c(2, 3, 4, 5, 6)  # Variable line weights based on quantity\n    \n    # Add routes based on the optimal quantities\n    for (i in seq_along(location())) {\n      wh_id <- location()[i]\n      wh_idx <- which(warehouses$ID == wh_id)\n      color_idx <- (wh_id - 1) %% length(route_colors) + 1\n      \n      for (j in 1:ncol(qty_data)) {\n        if (qty_data[i, j] > 0) {\n          route_start <- warehouses[warehouses$ID == wh_id, c(\"Longitude\", \"Latitude\")]\n          route_end <- distribution_centers[distribution_centers$ID == j, c(\"Longitude\", \"Latitude\")]\n          \n          # Calculate line weight based on quantity (normalized)\n          weight_multiplier <- qty_data[i, j] / max(optimal_quantities) * 5\n          weight <- max(2, min(6, weight_multiplier + 2))  # Scale between 2-6\n          \n          map <- map %>%\n            addPolylines(\n              lat = c(route_start$Latitude, route_end$Latitude),\n              lng = c(route_start$Longitude, route_end$Longitude),\n              color = route_colors[color_idx],\n              weight = weight,\n              opacity = 0.7,\n              label = paste0(\"Quantity: \", round(qty_data[i, j], 2)),\n              dashArray = \"5, 5\",\n              popup = paste0(\n                \"<strong>From:</strong> Warehouse \", wh_id,\n                \"<br><strong>To:</strong> Distribution Center \", j,\n                \"<br><strong>Quantity:</strong> \", round(qty_data[i, j], 2)\n              )\n            )\n        }\n      }\n    }\n    \n    map  # Return the modified map\n  })\n  \n  # Render the cost table\n  output$cost_table <- renderDT({\n    req(location())\n    \n    cost_data <- result %>% \n      filter(Warehouse %in% paste(\"WH\", location())) %>% \n      select(c(Warehouse, DC, Loading_Cost, Transport_cost))\n    \n    # Add a Total Cost column\n    cost_data$Total_Cost <- cost_data$Loading_Cost + cost_data$Transport_cost\n    \n    # Format currency values\n    cost_data$Loading_Cost <- formatC(cost_data$Loading_Cost, format=\"f\", digits=0, big.mark=\",\")\n    cost_data$Transport_cost <- formatC(cost_data$Transport_cost, format=\"f\", digits=0, big.mark=\",\")\n    cost_data$Total_Cost <- formatC(cost_data$Total_Cost, format=\"f\", digits=0, big.mark=\",\")\n    \n    datatable(cost_data,\n              options = list(\n                pageLength = 10,\n                dom = 'Bfrtip',\n                buttons = c('copy', 'csv', 'excel'),\n                initComplete = JS(\n                  \"function(settings, json) {\",\n                  \"$(this.api().table().header()).css({'background-color': '#3b5998', 'color': 'white'});\",\n                  \"}\"\n                ),\n                columnDefs = list(\n                  list(className = 'dt-center', targets = \"_all\")\n                )\n              ),\n              rownames = FALSE,\n              class = 'compact stripe hover') %>%\n      formatStyle(\n        'Warehouse',\n        backgroundColor = styleEqual(\n          paste(\"WH\", 1:5), \n          c('#FFC3A0', '#A0D2FF', '#C8FFB0', '#D5A0FF', '#FFF0A0')\n        )\n      ) %>%\n      formatStyle(\n        'DC',\n        backgroundColor = styleEqual(\n          c(\"DC 1\", \"DC 2\", \"DC 3\"), \n          c('#FFDDC3', '#C3E5FF', '#DDFFC3')\n        )\n      )\n  })\n  \n  \n  # Create and render the Sankey diagram\n  selected_indices <- reactive({\n    as.numeric(sub(\"Warehouse \", \"\", input$warehouse))\n  })\n  \n  # Filter data based on selected warehouses\n  filtered_data <- reactive({\n    result %>%\n      filter(Warehouse %in% paste(\"WH\",input$warehouse))\n  })\n\n  # Create and render the Sankey diagram\n  output$sankey_diagram <- renderUI({\n    req(length(selected_indices()) > 0)\n    \n    # Create links data frame\n    links <- data.frame()\n    \n    # Add links for each selected warehouse\n    for (i in 1:length(selected_indices())) {\n      wh_idx <- selected_indices()[i]\n      wh_data <- optimal_quantities[wh_idx, , drop = FALSE]\n      \n      # Add links for each DC\n      for (j in 1:ncol(wh_data)) {\n        if (wh_data[1, j] > 0) {\n          links <- rbind(links, data.frame(\n            source = i - 1,  # Use index in selected warehouses (0-based)\n            target = length(selected_indices()) + j - 1,  # DCs come after warehouses\n            value = wh_data[1, j]\n          ))\n        }\n      }\n    }\n    \n    # Only proceed if we have links\n    req(nrow(links) > 0)\n    \n    # Create nodes data frame\n    nodes <- data.frame(\n      name = c(paste(\"Warehouse\", selected_indices()), paste(\"DC\", 1:3))\n    )\n    \n    # Create the Sankey network\n    sankey <- sankeyNetwork(\n      Links = links, \n      Nodes = nodes, \n      Source = \"source\", \n      Target = \"target\", \n      Value = \"value\",\n      NodeID = \"name\",\n      height = 500,  \n      width = 800,\n      fontSize = 12,\n      nodeWidth = 20,\n      sinksRight = TRUE\n    )\n    \n    # Customize tooltips and add click functionality to show a value panel\n    sankey <- htmlwidgets::onRender(sankey, \"\n    function(el, x) {\n      // Create a div for the value panel\n      var valuePanel = d3.select('body').append('div')\n        .attr('class', 'value-panel')\n        .style('position', 'absolute')\n        .style('padding', '8px')\n        .style('background', 'lightgray')\n        .style('border', '1px solid gray')\n        .style('border-radius', '4px')\n        .style('opacity', 0);  // Start hidden\n\n      // Append title for tooltips on hover\n      d3.selectAll('.link')\n        .append('title')\n        .text(function(d) { return 'Quantity: ' + d.value.toFixed(2); });  // Show value on hover\n\n      // Add click event to show the value panel\n      d3.selectAll('.link')\n        .on('click', function(event, d) {\n          // Ensure we get the correct value\n          var value = d3.select(this).datum().value;\n          var source = nodes.name[d.source.index];\n          var target = nodes.name[d.target.index];\n\n          // Position the value panel near the mouse cursor\n          valuePanel\n            .style('left', (event.pageX + 5) + 'px')\n            .style('top', (event.pageY + 5) + 'px')\n            .style('opacity', 1)  // Make it visible\n            .html('From: ' + source + '<br>To: ' + target + '<br>Quantity: ' + value.toFixed(2));  // Set the text with details\n\n          // Hide the panel after a delay\n          setTimeout(function() {\n            valuePanel.style('opacity', 0);\n          }, 3000);  // Change the delay as needed\n        });\n    }\n    \")\n    \n    # Add title and caption\n    tagList(\n      sankey,\n      tags$p(style = \"font-size: 12px; text-align: right;\", \n             \"A wider arrow indicates that a larger quantity is being sent from that warehouse to a distribution center.\")\n    )\n  })\n  \n  # Add a summary statistics output at the bottom of the map tab\n  output$summary_stats <- renderUI({\n    req(location())\n    \n    selected_data <- result %>% \n      filter(Warehouse %in% paste(\"WH\", location()))\n    \n    total_loading <- sum(selected_data$Loading_Cost)\n    total_transport <- sum(selected_data$Transport_cost)\n    total_weight <- sum(selected_data$Total_Weight)\n    \n    div(\n      class = \"mt-3 p-3 bg-light rounded\",\n      h4(\"Summary Statistics\", class = \"text-primary mb-3\"),\n      div(class = \"row\",\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-primary mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Weight\"),\n                      h3(class = \"card-text\", paste0(round(total_weight, 2), \" tons\"))\n                  )\n              )\n          ),\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-success mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Loading Cost\"),\n                      h3(class = \"card-text\", paste0(\"₫\", formatC(total_loading, format=\"f\", digits=0, big.mark=\",\")))\n                  )\n              )\n          ),\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-info mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Transport Cost\"),\n                      h3(class = \"card-text\", paste0(\"₫\", formatC(total_transport, format=\"f\", digits=0, big.mark=\",\")))\n                  )\n              )\n          )\n      )\n    )\n  })\n}\n\n# Run the application \nshinyApp(ui = ui, server = server)\n```\n:::\n\nBạn có thể thấy với **dashboard** như vậy, ta có thể xem được nhiều thông tin hơn như:\n\n-   Vị trí cụ thể của từng *WH* và *DC* cũng như là các tuyến đường dự kiến bằng các đường thẳng minh họa. (Xem **Map tab**)\n\n-   Thông tin về chi phí *Loading cost* và *Transporation cost* cũng như lượng hàng cần vận chuyển cho từng nhà kho. (Xem **Table and Sankey tab**)\n\nBạn có thể xem cho 1 hoặc nhiều nhà kho bằng cách *click* trên thanh **Filter**. Ngoài ra, đặc biệt với **Sankey chart**, bạn cần giữ hoặc *click* chuột vào tuyến để xem được số lượng hàng.\n\nTuy rất thích R nhưng mình vẫn không thích xây dựng dashboard bằng R lắm vì quá nặng về code và không hiệu quả về thời gian, nguồn lực. Các tools khác mình ưu tiên hơn như **Power BI**, **Tableau** hoặc các **BIs** mà công ty bạn sử dụng trong công việc hằng ngày.\n\n## Mô hình MILP:\n\nTiếp theo ta sẽ chuyển sang thuật toán tuyến tính mới là mô hình MILP.\n\n### Giới thiệu sơ lược:\n\n**MILP (Mixed Integer Linear Programming)** là một phương pháp tối ưu hóa được sử dụng trong các bài toán lập kế hoạch, phân bổ tài nguyên, và quyết định trong các lĩnh vực như logistics, sản xuất, tài chính, và nhiều lĩnh vực khác. MILP là một phần mở rộng của lập trình tuyến tính (Linear Programming - LP), trong đó có các biến là số nguyên (integer variables) bên cạnh các biến liên tục (continuous variables).\n\nTrong đó, cấu trúc của một bài toán MILP bao gồm:\n\n1.  **Hàm mục tiêu**: Là một hàm tuyến tính mà bạn muốn tối ưu hóa (tối đa hóa hoặc tối thiểu hóa).\n\n    $$\n    \\text{Maximize or Minimize } Z = c_1x_1 + c_2x_2 + \\ldots + c_nx_n\n    $$\n\n2.  **Ràng buộc**: Bao gồm các điều kiện tuyến tính mà các biến phải thỏa mãn.\n\n    $$\n    a_{11}x_1 + a_{12}x_2 + \\ldots + a_{1n}x_n \\leq b_1\n    $$\n\n    $$\n    a_{21}x_1 + a_{22}x_2 + \\ldots + a_{2n}x_n \\leq b_2\n    $$\n\n    ... và nhiều ràng buộc khác.\n\n3.  **Biến quyết định**: Các biến trong bài toán có thể là:\n\n    -   Biến liên tục: Có thể nhận mọi giá trị thực (ví dụ: số lượng sản phẩm).\n    -   Biến nguyên: Chỉ nhận giá trị nguyên (ví dụ: số lượng xe tải).\n    -   Biến nhị phân: Chỉ nhận giá trị 0 hoặc 1 (ví dụ: có hoặc không sử dụng một nhà máy).\n\nMô hình **MILP** là một công cụ mạnh mẽ cho việc tối ưu hóa trong nhiều lĩnh vực khác nhau. Với khả năng kết hợp giữa các biến liên tục và số nguyên, MILP có thể giải quyết nhiều bài toán phức tạp mà các phương pháp tối ưu hóa khác không thể thực hiện hiệu quả. Các ứng dụng phổ biến bao gồm:\n\n-   **Quản lý chuỗi cung ứng**: Tối ưu hóa việc phân phối hàng hóa từ các kho đến các khách hàng.\n-   **Lập kế hoạch sản xuất**: Xác định số lượng sản phẩm cần sản xuất để tối đa hóa lợi nhuận hoặc giảm chi phí.\n-   **Tối ưu hóa lịch trình**: Lập lịch cho nhân viên, máy móc, hoặc tài nguyên để tối ưu hóa hiệu suất.\n-   **Quy hoạch đô thị**: Tối ưu hóa việc sử dụng đất và tài nguyên trong quy hoạch thành phố.\n\nTrong R có các thư viện như `lpSolve`, `ompr`, và `ROI` có thể được sử dụng để giải quyết các bài toán MILP.\n\n### Ví dụ về mô hình MILP:\n\nGỉa sử ta có bài toán về vấn đề **Transshipment** có yêu cầu là tìm ra phương án vận tải tối ưu nhất để vận chuyển hàng hóa từ nhà máy (**Factory**) thông qua **Crossdocking** và đến được **Distribution Center** với mục tiêu là đạt **chi phí thấp nhất**.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/transshipment.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 5: Vấn đề Transshipment\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://posit.co/download/rstudio-desktop/\">Rstudio</a>\n  </div>\n</div>\n```\n\nVì bài toán này thuộc dạng tuyến tính nên phương pháp MILP sẽ làm tốt hơn nhiều so với thuật toán GA bên trên. Kết quả được trình bày bên dưới đây\n\n```{r}\n#| warning: false\n#| message: false\n#| output: false\n#| fig-cap: \"Biểu đồ 4: Kết quả từ mô hình MILP\"\nlibrary(ompr)\nlibrary(ompr.roi)\nlibrary(ROI.plugin.glpk)\n#Input:\nSupply <-c(200,300,100,150,220)\nDemand <-c(150,100,110,200,180)\nDC<-2\nm<-length(Supply)\nn<-length(Demand)\n\nCost_CD<-read.table(text = \n                    \"CD1 CD2\n                     30 50\n                     23 66\n                     35 14\n                     70 12\n                     65 70\",header = T)\nCost_DC<-read.table(text = \n                      \"DC1 DC2 DC3 DC4 DC5\n                       12 25 22 40 41\n                       65 22 23 12 15\",header = T)\n\n#MILP model from the \nmodel5 <- MIPModel() %>%\n  # Add variable\n  add_variable(x[i, j], i = 1:m, j = 1:DC) %>%\n  add_variable(y[j, k], j = 1:DC, k = 1:n) %>%\n  # minimize the cost of transshipment:\n  set_objective(sum_expr(x[i, j]*Cost_CD[i, j],i = 1:m, j = 1:DC)+ sum_expr(y[j, k]*Cost_DC[j, k], k = 1:n, j = 1:DC),\"min\") %>%\n  add_constraint(sum_expr(y[j, k], j = 1:DC) >= Demand[k], k = 1:n) %>%\n  # The amount of inventory in Crossdocking is smaller than production goods\n  add_constraint(sum_expr(x[i, j], j = 1:DC) <= Supply[i], i = 1:m) %>% \n  # The amount of is bigger than demand in DC\n  add_constraint(sum_expr(x[i, j], i = 1:m) - sum_expr(y[j, k], k = 1:n) >= 0,j = 1:DC) %>%\n  add_constraint(x[i, j] >= 0, j = 1:DC, i = 1:m)%>% \n  add_constraint(y[j, k] >= 0, j = 1:DC, k = 1:n)%>% \n  #Solve the model:\n  solve_model(with_ROI(solver = \"glpk\", verbose = TRUE))\n```\n\n```{r}\n#| layout: [[50,50]]\n#| warning: false\n#| message: false\n#| echo: false\n\n## Table:\nsolution <- get_solution(model5, x[i, j]) %>% \n     filter(value > 0)\n\nlibrary(gt)\nlibrary(dplyr)\nlibrary(scales)  \n\n# Assuming `solution` contains the results of x[i, j]\n# Transform the solution into a tidy format for the table\ntable_data <- solution %>%\n  rename(Manufacturer = i, DC = j, Flow = value) %>%\n  mutate(Manufacturer = paste(\"Manufacturer\", Manufacturer),\n         DC = paste(\"DC\", DC)) %>% \n  select(-variable)\n\n# Create a gt table\ntable_data %>%\n  gt() %>%\n  tab_header(\n    title = md(\"**Transshipment flows from Manufacturers to Distribution Centers**\")\n  ) %>%\n  cols_label(\n    Manufacturer = md(\"**Manufacturer**\"),\n    DC = md(\"**Distribution Center**\"),\n    Flow = md(\"**Flow Amount**\")) %>%\n  fmt_number(\n    columns = c(Flow),\n    decimals = 2\n  ) %>%\n  data_color(\n    columns = c(Flow),  # Use c() instead of vars()\n    colors = scales::col_numeric(palette = c(\"#2ca02c\",\"#ff7f0e\"), domain = NULL)\n  ) %>%\n  cols_align(\n    align = \"center\",\n    columns = everything()  # Applies to all columns\n  ) %>%\n  tab_options(\n    table.width = pct(100)\n  ) %>% \n  gt_theme_espn()\n\n## Barchart:\n\nlibrary(ggplot2)\nplot_data <- solution %>%\n  rename(Manufacter= i, DC = j, Flow = value) %>%\n  mutate(Manufacter = paste(\"Manufacter\", Manufacter),\n         DC = paste(\"DC\", DC))\n\n# Create a plot\nggplot(plot_data, aes(x = Manufacter, y = Flow, fill = DC)) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  theme_minimal() +\n  labs(title = \"\",\n       x = \"Manufacters\",\n       y = \"Flow Amount\",\n       fill = \"Distribution Centers\") +\n  theme(text = element_text(size = 12),\n        axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_brewer(palette = \"Set2\")\n```\n\nNhư vậy, chúng ta đã được học về thuật toán Genetic và mô hình MILP cũng như cách thực hiện trong Rstudio.\n\nNếu bạn có câu hỏi hay thắc mắc nào, đừng ngần ngại liên hệ với mình qua Gmail. Bên cạnh đó, nếu bạn muốn xem lại các bài viết trước đây của mình, hãy nhấn vào hai nút dưới đây để truy cập trang **Rpubs** hoặc mã nguồn trên **Github**. Rất vui được đồng hành cùng bạn, hẹn gặp lại! 😄😄😄\n\n```{=html}\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Contact Me</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css\">\n    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg\">\n    <style>\n        body { font-family: Arial, sans-serif; background-color: $secondary-color; }\n        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }\n        label { display: block; margin: 10px 0 5px; }\n        input[type=\"email\"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }\n        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }\n        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }\n        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }\n        .rpubs-button button { background-color: #75AADB; }\n        .rpubs-button button:hover { background-color: #5A9BC2; }\n        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }\n        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h2>Contact Me</h2>\n        <form id=\"emailForm\">\n            <label for=\"email\">Your Email:</label>\n            <input type=\"email\" id=\"email\" name=\"email\" required aria-label=\"Email Address\">\n            <div class=\"error-message\" id=\"error-message\" style=\"display: none;\">Please enter a valid email address.</div>\n            <button type=\"submit\">Send Email</button>\n        </form>\n        <div class=\"github-button\">\n            <button>\n                <a href=\"https://github.com/Loccx78vn\" target=\"_blank\" style=\"color: white; text-decoration: none;\">\n                    <i class=\"fab fa-github\"></i> View Code on GitHub\n                </a>\n            </button>\n        </div>\n        <div class=\"rpubs-button\">\n            <button>\n                <a href=\"https://rpubs.com/loccx\" target=\"_blank\" style=\"color: white; text-decoration: none;\">\n                    <img src=\"https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg\" alt=\"RStudio icon\" class=\"rpubs-icon\"> Visit my RPubs\n                </a>\n            </button>\n        </div>\n    </div>\n\n    <script>\n        document.getElementById('emailForm').addEventListener('submit', function(event) {\n            event.preventDefault(); // Prevent default form submission\n            const emailInput = document.getElementById('email');\n            const email = emailInput.value;\n            const errorMessage = document.getElementById('error-message');\n\n            // Simple email validation regex\n            const emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\n            if (emailPattern.test(email)) {\n                errorMessage.style.display = 'none'; // Hide error message\n                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email\n                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;\n                window.open(gmailLink, '_blank'); // Open in new tab\n            } else {\n                errorMessage.style.display = 'block'; // Show error message\n            }\n        });\n    </script>\n</body>\n</html>\n```\n","srcMarkdownNoYaml":"\n\n# Giới thiệu:\n\n```{r}\n#| warning: false\n#| message: false\n#| echo: false\n#Call packages\npacman::p_load(rio,\n               here,\n               janitor,\n               tidyverse,\n               dplyr,\n               magrittr,\n               ggplot2,\n               purrr,\n               lubridate,\n               mice,\n               plotly,\n               DiagrammeR,\n               shinylive)\n```\n\n## Vài điểm về thuật toán Genetic:\n\n**GA** hay **Genetic Algorithm** là 1 thuật toán tối ưu hóa ngẫu nhiên (**stochastic search algorithms**), được phát triển dựa trên lý thuyết tiến hóa và sự chọn lọc tự nhiên của sinh học [@lucascrucca2013].\n\nỞ thời cấp 3, bạn đã từng học về lý thuyết tiến hóa và chọn lọc tự nhiên của [Charles Darwin](https://vi.wikipedia.org/wiki/Charles_Darwin) và [Alfred Russel](https://vi.wikipedia.org/wiki/Alfred_Russel_Wallace) ở môn Sinh học. Nếu bạn cũng từng liệt Sinh như tôi thì bạn quên cũng không sao 😅😅. Vậy thì để tôi giải thích lại như sau:\n\nSự tiến hóa là sự thay đổi đặc điểm di truyền của 1 quần thể sinh vật, ví dụ điển hình chính là từ loại vượn đã tiến hóa thành hình dạng con người văn minh như các bạn bây giờ. Vậy quá trình tiến hóa đó diễn ra khi có sự chọn lọc tự nhiên tạo ra các biến dị di truyền (Ví dụ: đột biến,...) và kết quả là các cá thể đột biến trở nên phổ biến hơn hoặc hiếm gặp hơn trong quần thể. Vậy điều kiện để xảy ra sự chọn lọc tự nhiên có thể là sự thay đổi về môi trường sống, địa lý,... dẫn tới sự khác nhau về khả năng sống sót và sinh sản.\n\nKết cục là xuất hiện các cá thể đột biến \"mạnh mẽ hơn\" hoặc đúng là \"đặc biệt hơn\" có khả năng tồn tại khi xuất hiện sự thay đổi lớn, ví dụ như dưới đây, do sự thay đổi về địa điểm sống, từ một loại chim sẻ đã phát triển thành 3 phân họ khác nhau.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Natural_selection.jpg\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 1: Ví dụ về chọn lọc tự nhiên\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://www.biologyonline.com/dictionary/natural-selection\">Link to Image</a>\n  </div>\n</div>\n```\n\nVậy lí thuyết này liên quan gì tới vấn đề tối ưu hóa. Thông thường khi bạn muốn tối ưu hóa một vấn đề gì đó, bạn cần xây dựng mô hình định lượng nó, ví dụ như dưới ảnh này ta đang có mô hình [MILP](https://www.mathworks.com/help/optim/ug/mixed-integer-linear-programming-algorithms.html) nhằm hoạch định tuyến đường và tối ưu hóa quãng đường di chuyển.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/MILP.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 2: Mô hình VRP\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://medium.com/@rihot_gusron/capacitated-vehicle-routing-problem-with-lingo-427c2d3bf724\">Link to Image</a>\n  </div>\n</div>\n```\n\nMục tiêu của hàm chính là tìm ra giá trị nhỏ nhất nghĩa là chi phí cho việc di chuyển của xe là nhỏ nhất. Do đó, bạn có thể hình dung rằng **giá trị nhỏ nhất** đó như là các **cá thể đột biến** có khả năng sống sót cao nhất trong quẩn thể.\n\nVì vậy thuật toán **Genetic** (GA) chính là lặp đi lặp lại sự chọn lọc tự nhiên trong một quần thể hoặc một mẫu để đến cuối cùng tìm ra cá thể vượt trội nhất.\n\n## Cách hoạt động GA trong ML:\n\nTrong Machine Learning, GA nhằm tìm ra đúng các biến cần thiết để xây dựng mô hình tốt nhất. Gỉa sử chúng ta có 2 mô hình là:\n\n-   Mô hình 1: gồm các biến A,C,D.\n-   Mô hình 2: gồm biến A,B,E.\n\nVậy mô hình nào mới là tốt nhất cho mô hình dự đoán ? Chúng ta chưa biết được và chỉ có thể so sánh nó thông qua thuật toán Genetic.\n\nVề quy trình, thuật toán Genetic sẽ có cách hoạt động như dưới đây. Quy trình này mình tham khảo của [@rohithgandhi2018].\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Genetic_Algorithm.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 3: Thuật toán Genetic\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://medium.datadriveninvestor.com/genetic-algorithms-9f920939f7cc\">Link to Image</a>\n  </div>\n</div>\n```\n\nDiễn giải cách hoạt động:\n\n-   Bước 1 (**Initialisation**): mỗi biến được xem là *Gene* và nhiều *Gene* gộp lại thành một mô hình hay gọi là *Chromosome* và nhiều *Chromosome* sẽ tạo thành một quần thể (*Population*). Việc này giống như là bạn đang trình bày hết các phương án có thể sử dụng.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/Term.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 4: Các thuật ngữ trong GA\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://www.doc.ic.ac.uk/research/technicalreports/2003/DTR03-4.pdf\">Link to Image</a>\n  </div>\n</div>\n```\n\n-   Bước 2 (**Fitness Function**): Bạn cần xây dựng một hàm mục tiêu để tính toán giá trị cho các mô hình ở bước 1.\n\n-   Bước 3 (**Selection**): Biến nào có giá trị yếu kém sẽ bị loại và quá trình tính toán sẽ tiếp tục ở thế hệ của nó tiếp theo. Diễn giải đơn giản hơn là chúng ta thử một cách khác và cố gắng cải thiện kết quả.\n\n-   Bước 4 (**Crossover**): Tạo ra mô hình gồm các biến tốt đã lựa chọn ở bước 3. Ví dụ như biến A, B là tốt cho mô hình.\n\n-   Bước 5 (**Mutation**): Thay đổi mô hình đầu vào đã bao gồm các biến ở bước 4 và bắt đầu lại từ bước 1. Ví dụ mô hình cần chọn gồm 5 biến và ta đã chọn được biến A,B là tốt. Do đó, khi quay lại bước 1, ta chỉ cần chọn thêm 3 biến thay vì 5 biến như thông thường.\n\n# Thực hành trong R:\n\nSau khi đã sơ lược về thuật toán, bây giờ ta sẽ vào phần thực hành trong R. Vậy làm sao để ứng dụng thuật toán Genetic trong R, mình đã kham khảo qua nhiều nguồn tài liệu và tổng hợp dưới đây:\n\n**Xây dựng hàm mục tiêu**: hàm mục tiêu là bước quan trọng nhất trong thuật toán Genetic vì nó là cơ sở để đánh giá và lựa chọn cá thể vượt trội nhất. Và hàm mục tiêu sẽ luôn khác nhau tùy vào vấn đề mà ta đặt ra. Giả sử chúng ta muốn tối ưu chi phí thì nó là hàm Min, còn ta muốn tối đa lợi nhuận thì nó sẽ là hàm Max.\n\nVậy hàm mục tiêu của bài toán trên trong R, bạn có thể tham khảo phần code bên dưới mình:\n\n::: callout-important\n### Type of fitness function\n\nĐối số `type` trong hàm có 3 giá trị:\n\n-   `\"binary\"`: đại diện cho biến quyết định dạng phân loại, ví dụ: có/không\n-   `\"real-valued\"`: dùng dể tối ưu cho các biến quyết định là dạng số thực, số tự nhiên.\n-   `\"permutation\"`: cho các vấn đề liên quan đến việc sắp xếp lại các biến thành danh sách, ví dụ: thang đo Likert.\n:::\n\nChi tiết về hàm `ga()`, bạn có thể tham khảo tài liệu của [@lucascrucca2013].\n\n## Thuật toán Genetic:\n\nVậy bây giờ chúng ta sẽ xử lí bài toán trên theo thuật toán **Genetic**\n\nGỉa sử chúng ta có bài toán về vận chuyển hàng từ nhà kho để thỏa mãn nhu cầu ở các điểm **DC (Distribution center)**. Và công thức để tính toán được chi phí là:\n\nHàm chi phí tổng thể được xác định như sau:\n\n$$\nTC = \\sum_{i=1}^{m} \\left( D_{ij} \\times \\frac{P}{F} \\times 0.4 + LC_i \\right) \\times Q_j\n$$\n\nTrong bài toán này, bạn sẽ cần dữ liệu để tính toán 2 thông số là: **Phí bốc xếp (Loading cost)** và **Chi phí vận chuyển (Transportation cost)**.\n\nNếu trong công việc thường ngày ở công ty, chúng ta sẽ cần lấy dữ liệu từ **Data warehouse** bằng SQL hoặc các phần mềm **Business Intelligence** khác. Ở đây, nhằm mục đích học tập, mình đã tạo ra code ở phía dưới để xây dựng dữ liệu cho các bạn luyện tập.\n\n```{r}\n# Create a data frame for loading costs\nloading_costs <- data.frame(\n  Warehouse = rep(paste(\"WH\", 1:5), each = 4),\n  ID = rep(1:5, times = 4),\n  Weight_Category = rep(c(\"< 2 tons\", \"2 to 5 tons\", \"5 to 10 tons\", \"> 10 tons\"), times = 5),\n  Has_Machine = rep(c(\"Yes\", \"No\", \"Yes\", \"No\", \"No\"), each = 4),\n  Loading_Cost = c(80, 100, 120, 160,  # Warehouse 1 (with machine)\n                   110, 150, 180, 210,  # Warehouse 2 (without machine)\n                   85, 105, 125, 140,  # Warehouse 3 (with machine)\n                   150, 170, 190, 210,  # Warehouse 4 (without machine)\n                   140, 165, 185, 215)   # Warehouse 5 (without machine)\n)\n\n# Set seed for reproducibility\nset.seed(123)\n\n# Define parameters\nweight_categories <- c(\"< 1.5\", \"1.5 to 2.5\", \"2.5 to 5\", \"5 to 10\", \"> 10\")\n# Create the data frame\nloading_costs <- data.frame(\n  Warehouse = rep(1:5, each = 15),  # 5 warehouses, 15 rows each\n  DC = rep(rep(1:3, each = 5), times = 5),  # Repeat 1, 2, 3 for each warehouse\n  Weight_Category = rep(weight_categories, times = 15),  # Repeat categories for 15 rows\n  Loading_Cost = round(runif(75, 5, 150), 2),\n  Has_Machine = sample(c(\"Yes\", \"No\"), 75, replace = TRUE)\n)\n\n# Define warehouses with coordinates (latitude, longitude)\nwarehouses <- data.frame(\n  ID = 1:5,\n  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060), # Example latitudes (Hanoi, HCMC, Da Nang, etc.)\n  Longitude = c(105.804, 108.2022, 106.6957, 108.2772, 105.7460) # Example longitudes\n)\n\n# Define distribution centers data in Vietnam (example coordinates)\ndistribution_centers <- data.frame(\n  ID = 1:3,\n  Demand = c(90, 30, 150),\n  Latitude = c(17.974855, 11.7769, 15.122327), # Example latitudes (Hanoi, Da Nang, HCMC)\n  Longitude = c(102.630867, 106.6957, 108.799357) # Example longitudes\n)\n```\n\nNếu bạn từng gặp khó khăn trong việc phải đối mặt với cả đống dữ liệu từ hệ thống và chưa biết lấy dữ liệu nào để phân tích hoặc gộp bảng nào qua bảng nào thì lời khuyên của mình là hãy vẽ bảng **Entity relation diagram (ERD)**.\n\n**ERD** là một công cụ trực quan dùng để mô tả cấu trúc dữ liệu trong cơ sở dữ liệu. ERD thể hiện các thực thể (*entities*), thuộc tính (*attributes*), và các mối quan hệ (*relationships*) giữa chúng. Các thực thể thường được biểu diễn dưới dạng hình chữ nhật, thuộc tính dưới dạng hình ellips, và mối quan hệ bằng hình thoi hoặc đường nối. ERD giúp lập kế hoạch cho thiết kế cơ sở dữ liệu, đảm bảo rằng các yếu tố dữ liệu và quan hệ giữa chúng được xác định rõ ràng, tạo nền tảng cho việc phát triển và quản lý dữ liệu hiệu quả.\n\nNhư biểu đồ dưới đây, mình đang có 3 bảng gồm:\n\n-   Bảng thông tin chi tiết về DC.\n\n-   Bảng thông tin chi tiết về WH.\n\n-   Bảng giá về loading cost và transportation cost từ WH đến DC.\n\nVà các bạn có thể dễ dàng hình dung các mối quan hệ thông qua bảng **Entity relation diagram (ERD)** dưới đây:\n\n```{r}\n#| echo: false\n#| fig-subcap: \"Biểu đồ 1: EDR model\"\nlibrary(datamodelr)\n# Create the data model from your data frames\ndm1 <- dm_from_data_frames(list(\n  Warehouses = warehouses,\n  Loading_Costs = loading_costs,\n  Distribution_Centers = distribution_centers\n)) %>%\n  dm_set_key(\"Warehouses\", \"ID\") %>%\n  dm_set_key(\"Loading_Costs\", c(\"Warehouse\", \"DC\")) %>%\n  dm_set_key(\"Distribution_Centers\", \"ID\") %>%\n  dm_add_references(\n    Loading_Costs$Warehouse == Warehouses$ID,  # Correct reference\n    Loading_Costs$DC == Distribution_Centers$ID  # Assuming this is the correct reference\n  )\n\n# Create and render the ERD\ndm_create_graph(dm1, rankdir = \"LR\", columnArrows = TRUE) %>%\n  dm_render_graph()\n```\n\n::: callout-tip\n### Tải package datamodelr:\n\nMình tạo biểu đồ này bằng thư viện `datamodelr`. Bạn có thể tải bằng cú pháp: `devtools::install_github(\"bergant/datamodelr\")`\n:::\n\n### Dữ liệu đầu vào:\n\nNhư vậy, dựa vào đó, ta sẽ tính toán được 2 *matrix* về chi phí:\n\n-   Bảng giá loading ở các kho. (Hình bên trái)\n\n-   Bảng chi phí vận chuyển từ từng WH đến các DCs. (Hình bên phải)\n\n```{r}\n#| warning: false\n#| message: false\n## Calculate the transportation cost:\n# Haversine distance function\nhaversine <- function(lat1, lon1, lat2, lon2) {\n  R <- 6371 # Radius of Earth in kilometers\n  dlat <- (lat2 - lat1) * pi / 180\n  dlon <- (lon2 - lon1) * pi / 180\n  a <- sin(dlat / 2) * sin(dlat / 2) +\n       cos(lat1 * pi / 180) * cos(lat2 * pi / 180) * \n       sin(dlon / 2) * sin(dlon / 2)\n  c <- 2 * atan2(sqrt(a), sqrt(1 - a))\n  R * c # Distance in kilometers\n}\n\n# Calculate distance matrix based on coordinates\ndistance_matrix <- matrix(0, nrow = nrow(warehouses), ncol = nrow(distribution_centers))\n\nfor (i in 1:nrow(warehouses)) {\n  for (j in 1:nrow(distribution_centers)) {\n    distance_matrix[i, j] <- haversine(\n      warehouses$Latitude[i], warehouses$Longitude[i],\n      distribution_centers$Latitude[j], distribution_centers$Longitude[j]\n    )\n  }\n}\n\n# Define the fuel price (example value)\nfuel_price <- 20 # Fuel price per kilometer\n\n# Calculate transportation costs\ntransportation_costs <- distance_matrix * fuel_price * 0.4\n\n## Calculate the loading cost:\nweights_per_good <- 0.1\n\nmean_loading_cost<-loading_costs %>% \n  group_by(DC, Warehouse) %>% \n  summarise(mean = mean(Loading_Cost,na.rm = TRUE)/1000/weights_per_good) %>% # Assumes weighted of goods is 0.1kg \n  ungroup()\n\nlibrary(data.table)\n# Reshape the data frame to a wide format\nmean_cost_matrix <- reshape2::dcast(mean_loading_cost,\n                          Warehouse ~ DC, \n                          value.var = \"mean\")\n\n# Convert the data frame to a matrix and remove the Warehouse column\nloading_costs_per_dc <- as.matrix(mean_cost_matrix[,-1])\n\n# Set row names as the warehouse names\nrownames(loading_costs_per_dc) <- mean_loading_cost$Warehouse[!duplicated(mean_loading_cost$Warehouse)]\n```\n\n```{r}\n#| warning: false\n#| message: false\n#| echo: false\n#| fig-cap: \"Tổng các phi phí cho việc bốc xếp và vận chuyển hàng hóa\"\n#| fig-subcap: [\"Biểu đồ 2: Heatmap cho bảng chi phí bốc xếp\", \"Biểu đồ 3: Bảng giá vận chuyển từ WH đến DC\"]\n#| layout-ncol: 2\n# Code tạo hai biểu đồ\n\nlibrary(ggplot2)\n\n# Convert the distance matrix to a data frame\ndistance_df <- reshape2::melt(transportation_costs)\ncolnames(distance_df) <- c(\"Warehouse\", \"Distribution_Center\", \"Transportation_Cost\")\n\n# Plot the distance matrix with updated colors\nggplot(distance_df, aes(x = Warehouse, \n                        y = Distribution_Center, \n                        fill = Transportation_Cost)) +\n  geom_tile(color = \"white\", linewidth = 0.5) +  # Add borders to tiles\n  geom_text(aes(label = scales::comma(Transportation_Cost, accuracy = 1)), \n            color = ifelse(distance_df$Transportation_Cost > \n                           max(distance_df$Transportation_Cost)/2, \"white\", \"black\"),\n            size = 3.5) +  # Adaptive text color\n  scale_fill_gradient2(\n    low = \"#f7fbff\", \n    mid = \"#6baed6\", \n    high = \"#08519c\",\n    midpoint = median(distance_df$Transportation_Cost),\n    name = \"Cost (VNĐ)\",\n    labels = scales::comma\n  ) +\n  theme_minimal() +\n  labs(\n    title = \"Transportation Costs Between Facilities\",\n    subtitle = \"Costs shown in Vietnamese Dong (VNĐ)\",\n    x = \"Warehouse\",\n    y = \"Distribution Center\"\n  ) +\n  theme(\n    axis.text.x = element_text(angle = 45, hjust = 1, face = \"bold\", size = 12),\n    axis.text.y = element_text(face = \"bold\", size = 12),\n    axis.title.x = element_text(size = 14, face = \"bold\", margin = margin(t = 15)),\n    axis.title.y = element_text(size = 14, face = \"bold\", margin = margin(r = 15)),\n    plot.title = element_text(face = \"bold\", size = 16),\n    plot.subtitle = element_text(size = 12, color = \"gray30\"),\n    panel.grid = element_blank(),  # Remove grid lines\n    legend.position = \"right\"\n  )\n\n# Convert the transportation costs matrix to a data frame\nlibrary(gt)\nlibrary(gtExtras)\n# Create a gt table\nm<-loading_costs %>%\n  mutate(Loading_Cost = Loading_Cost * 1000,\n         DC = paste(\"DC\",DC),\n         Warehouse = paste(\"WH\",Warehouse)) # Convert to currency\n  \nhead(m[order(-m$Loading_Cost),]) %>% \n  gt() %>%\n  fmt_currency(\n    columns = Loading_Cost,\n    currency = \"VND\",\n    decimals = 0,\n    use_seps = TRUE\n  ) %>%\n  tab_header(\n    title = md(\"**Loading Costs by weight category in each warehouses**\"),\n    subtitle = md(\"Table just contains **expected loading cost**\")\n  ) %>%  \n  opt_align_table_header(align = \"center\") %>% \n  cols_label(\n    Loading_Cost = \"Loading Cost (VNĐ)\",\n    Weight_Category = \"Weight Category\",\n    Has_Machine = \"Has Machine\",\n    DC = \"Distribution Center\"\n  ) %>% \n  data_color(method = \"numeric\",\n             palette = \"viridis\",\n             reverse = TRUE) %>% \n  gt_theme_pff() %>% \n  tab_style(style = list(cell_text(align = \"center\")),\n            locations = cells_body(columns = everything())) %>%\n  tab_style(\n    style = list(\n      cell_text(align = \"center\")\n    ),\n    locations = list(\n      cells_column_labels(everything())\n    )\n  ) %>% \n  tab_source_note(source = md(\"*Source: package gt in R*\")) %>% \n  tab_style(\n    style = \"font-weight: bold\",\n    locations = cells_body(Weight_Category)\n  )\n  \n```\n\n### Xây dựng hàm mục tiêu:\n\nSau khi đã có đủ dữ liệu, bạn sẽ bắt đầu viết hàm mục tiêu và dùng thuật toán GA để tìm ra giá trị tối ưu nhất.\n\nTrong hàm `ga` từ gói **GA** trong R, có một số đối số quan trọng cho phép bạn tùy chỉnh thuật toán di truyền. Dưới đây là một cái nhìn tổng quan về một số đối số quan trọng:\n\n-   **type**: Chỉ định loại tối ưu hóa (ví dụ: `\"real-valued\"`, `\"binary\"` hoặc `\"permutation\"`).\n\n-   **fitness**: Hàm đánh giá độ phù hợp; nó nên nhận một vector tham số làm đầu vào và trả về một giá trị số.\n\n-   **lower** và **upper**: Định nghĩa giới hạn cho các biến nếu bạn đang tối ưu hóa trong không gian liên tục (dùng cho các loại giá trị thực).\n\n-   **popSize**: Thiết lập kích thước quần thể cho mỗi thế hệ.\n\n-   **maxiter**: Chỉ định số thế hệ tối đa để chạy thuật toán.\n\n-   **run**: Chỉ định số thế hệ để chạy thuật toán mà không có sự cải thiện trước khi dừng lại.\n\n-   **pmutation**: Xác suất xảy ra đột biến trong quần thể.\n\n-   **elitism**: Xác định xem các cá thể tốt nhất có nên được giữ lại trong thế hệ tiếp theo hay không.\n\nNhững đối số này giúp điều chỉnh thuật toán di truyền cho các nhu cầu tối ưu hóa cụ thể của bạn, cho phép hiệu suất tốt hơn và hội tụ về các giải pháp tối ưu.\n\nNgoài ra, còn có các lưu ý cho bạn khi sử dụng R như sau:\n\n::: callout-caution\n### Lưu ý khi dùng hàm ga():\n\nHàm `ga()` phải có ít nhất 2 đối số là `type` và `fitness thì R mới chạy được.`\n\n-   Riêng khi type = \"binary\" thì cần thêm đối số `nBits.`\n\n-   Còn khi `type = \"real-valued\"/\"permutation\"` thì cần thêm đối số `min` và `max`.\n:::\n\n```{r}\n#| message: false\n#| warning: false\n#| output: false\n# Load necessary library\nlibrary(GA)\ndemand<-c(distribution_centers$Demand)\n\n# Define the objective function\nobjective_function <- function(quantities) {\n    quantities_matrix <- matrix(quantities, \n                                nrow = 5, \n                                ncol = 3, \n                                byrow = TRUE)\n    \n    # Calculate total loading costs\n    loading_costs <- rowSums(quantities_matrix) * loading_costs_per_dc  # Total loading costs for each DC\n    # Calculate total transportation costs\n    transportation_costs <- sum(quantities_matrix * transportation_costs)\n    \n    # Combine both costs\n    total_cost <- sum(loading_costs) + transportation_costs\n    \n    # Check if demands are met\n    if (any(colSums(quantities_matrix) < demand)) {\n        return(Inf)  # Penalize if demands are not met\n    }\n    \n    return(total_cost)\n}\n\n# Set up the Genetic Algorithm\nnum_vars <- 5 * 3  # 5 warehouses, 3 distribution centers\nga_result <- ga(\n    type = \"real-valued\",\n    fitness = function(x) -objective_function(x),  # Negate for minimization\n    lower = rep(0, num_vars),  # Minimum quantity\n    upper = rep(100, num_vars),  # Maximum quantity (adjust as needed)\n    popSize = 50,\n    maxiter = 100,\n    run = 10,\n    monitor = TRUE\n)\n```\n\n```{r}\n#| echo: false\n#| warning: false\n#| message: false\nlibrary(leaflet)\n## Update flag of countries in each locations:\nlibrary(readxl)\nwrite <- read_excel(\"write.xlsx\")\nwarehouses<-write[1:5,]\ndistribution_centers<-write[6:8,]\n```\n\n```{r}\n#| warning: false\n#| message: false\n# Assuming ga_result@solution contains optimal quantities\nga_result_solution <- c(ga_result@solution)\n\n# Reshape the solution into a matrix (5 warehouses x 3 DCs)\noptimal_quantities <- matrix(ga_result@solution,\n                             nrow = 5, \n                             ncol = 3, \n                             byrow = TRUE)\n\n# Convert the matrix to a data frame\nweights<-optimal_quantities* weights_per_good\n\nrownames(weights) <- 1:5\ncolnames(weights) <- 1:3\n\nlibrary(reshape2)\nreal_weighted <- melt(weights)\n\n# Rename the columns\ncolnames(real_weighted) <- c(\"Warehouse\", \"DC\", \"Total_Weight\")\n\n# Perform left join\nresult <- real_weighted %>%\n  left_join(loading_costs, by = c(\"Warehouse\", \"DC\"))\n\nresult <-result %>% \n  mutate(Price = case_when(\n    Total_Weight < 1.5 ~ \"< 1.5\",\n    Total_Weight <2.5 ~ \"1.5 to 2.5\",\n    Total_Weight < 5 ~ \"2.5 to 5\",\n    Total_Weight < 10 ~ \"5 to 10\",\n    Total_Weight >= 10 ~ \"> 10\",\n      is.na(Total_Weight) ~ NA_character_  # Handle NA explicitly if needed\n  ))\n  \nresult<-result %>% \n  filter(Weight_Category == Price) %>% \n  select(-Price)\n\n# Join with tranportation cost table:\nrownames(transportation_costs) <- 1:5\ncolnames(transportation_costs) <- 1:3\n\ntransport<-melt(transportation_costs)\n\n# Rename the columns\ncolnames(transport) <- c(\"Warehouse\", \"DC\", \"Transport_cost\")\n\n\nresult<-left_join(result,\n                  transport,\n                  by=c(\"Warehouse\", \"DC\"))\n\n# Adjust:\n\nresult<-result %>% \n      mutate(Loading_Cost = Loading_Cost*1000,\n             Transport_cost = Transport_cost*1000,\n             DC = paste(\"DC\",DC),\n             Warehouse = paste(\"WH\",Warehouse)) \n\n# Reorder cols in table:\nresult<-result[,c(\"Warehouse\",\n                 \"DC\",\n                 \"Has_Machine\",\n                 \"Total_Weight\",\n                 \"Weight_Category\",\n                 \"Loading_Cost\",\n                 \"Transport_cost\")]\n```\n\n### Báo cáo:\n\nVà cuối cùng, sau khi có kết quả, mình sẽ dùng các thư viện gồm: **Leaflet**, **gt**, và **biểu đồ Sankey** phục vụ những mục đích khác nhau cho trực quan hóa dữ liệu.\n\n1.  **Leaflet**: Đây là một thư viện mạnh mẽ để tạo bản đồ tương tác. Nó cho phép người dùng dễ dàng thêm các lớp, điểm đánh dấu và pop-up, rất lý tưởng để trực quan hóa dữ liệu địa lý. Leaflet đặc biệt hữu ích để hiển thị các dữ liệu như vị trí, lộ trình, hoặc phân bố không gian.\n\n2.  **gt**: Gói **gt** được thiết kế để tạo ra các bảng chất lượng cao trong R. Nó cho phép người dùng định dạng và tạo kiểu cho bảng một cách dễ dàng, giúp chúng trở nên hấp dẫn và dễ đọc. gt hỗ trợ các tính năng như định dạng tùy chỉnh, dòng tóm tắt, và thậm chí thêm chú thích, nâng cao cách trình bày dữ liệu trong báo cáo.\n\n3.  **Biểu đồ Sankey**: Những biểu đồ này được sử dụng để trực quan hóa luồng và mối quan hệ giữa các danh mục khác nhau. Trong R, gói **networkD3** hoặc **ggalluvial** có thể tạo ra biểu đồ Sankey, giúp hiểu cách các giá trị di chuyển giữa các nút, chẳng hạn như theo dõi hành trình người dùng hoặc hiển thị phân bổ tài nguyên.\n\nĐể kết nối các biểu đồ lại với nhau, ta thường nghĩ đến `Shiny` trong **R** nhưng vì chúng ta đang tạo website bằng **Quarto** nên output cuối cùng sẽ là một trang web tĩnh - *static website*. Do đó, nó sẽ không phản hồi với thông tin đầu vào của người dùng hoặc chạy bất kỳ mã R nào. Bạn có thể hình dung giống như bạn đang muốn xem biểu đồ về doanh thu trong tháng tiếp theo trên 1 biểu đồ trong Word - không thể làm được vì nó thuộc dạng văn bản, bạn chỉ đọc hoặc nhìn chứ không tương tác được.\n\nTuy vậy, sau một thời gian tìm hiểu, mình cũng tìm được cách để nhúng **Shiny** vào R để hiển thị trên Quarto. Nguồn tài liệu bạn có thể kham khảo ở trang này [r-shinylive-demo](https://github.com/coatless-quarto/r-shinylive-demo).\n\n:::{.column-page}\n\n```{shinylive-r}\n#| viewerHeight: 1000\n#| standalone: true\n#| fig-cap: \"Biểu đồ 3: Dashboard về lịch trình vận chuyển hàng dự tính\"\npacman::p_load(\n  leaflet,\n  dplyr,\n  networkD3,\n  shiny,\n  bslib,\n  DT,\n  htmltools\n)\n\n# Add value:\n# Convert GA solution to a matrix\n# Optimal quantities matrix\noptimal_quantities <- matrix(c(\n  43.306058, 10.87137, 13.26283,\n  15.524054, 30.42748, 48.86716,\n  7.599769, 44.93531, 27.46289,\n  18.556927, 17.60396, 41.85203,\n  16.305016, 13.15498, 21.79634\n), nrow = 5, ncol = 3, byrow = TRUE)\n\n# Warehouse data:\nwarehouses <- data.frame(\n  ID = 1:5,\n  Latitude = c(21.0285, 16.0545, 10.7769, 14.0583, 19.8060),\n  Longitude = c(105.8040, 108.2022, 106.6957, 108.2772, 105.7460),\n  District = c(\"Đống Đa\", \"Hải Châu\", \"Quận 1\", \"Mang Yang\", \"Đông Sơn\"),\n  Province = c(\"Hà Nội\", \"Đà Nẵng\", \"Hồ Chí Minh\", \"Gia Lai\", \"Thanh Hóa\"),\n  Address = c(\n    \"2RH3+9HX Đống Đa, Hà Nội, Việt Nam\",\n    \"3632+RV4 Hải Châu, Đà Nẵng, Việt Nam\",\n    \"QMGW+Q74 Quận 1, Hồ Chí Minh, Việt Nam\",\n    \"375G+8VG Mang Yang, Gia Lai, Việt Nam\",\n    \"RP4W+99X Đông Sơn, Thanh Hóa, Việt Nam\"\n  )\n)\n\n# Distribution center data:\ndistribution_centers <- data.frame(\n  ID = 1:3,\n  Latitude = c(17.97486, 11.77690, 15.12233),\n  Longitude = c(102.6309, 106.6957, 108.7994),\n  District = c(\"Viêng Chăn\", \"Lộc Ninh\", \"Quảng Ngãi\"),\n  Province = c(\"Lào\", \"Bình Phước\", \"Quảng Ngãi\"),\n  Address = c(\n    \"XJFJ+W8X Viêng Chăn, Lào\",\n    \"QMGW+Q74 Lộc Ninh, Bình Phước, Việt Nam\",\n    \"4QCX+WPQ Quảng Ngãi, Việt Nam\"\n  )\n)\n\n# Create a data frame with the warehouse data\nresult <- data.frame(\n  Warehouse = c(\"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\",\n                \"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\",\n                \"WH 1\", \"WH 2\", \"WH 3\", \"WH 4\", \"WH 5\"),\n  DC = c(\"DC 1\", \"DC 1\", \"DC 1\", \"DC 1\", \"DC 1\",\n         \"DC 2\", \"DC 2\", \"DC 2\", \"DC 2\", \"DC 2\",\n         \"DC 3\", \"DC 3\", \"DC 3\", \"DC 3\", \"DC 3\"),\n  Has_Machine = c(\"Yes\", \"No\", \"No\", \"No\", \"No\",\n                  \"No\", \"No\", \"No\", \"No\", \"No\",\n                  \"No\", \"No\", \"No\", \"No\", \"No\"),\n  Total_Weight = c(4.3306058, 1.5524054, 0.7599769, 1.8556927, 1.6305016,\n                   1.0871366, 3.0427479, 4.4935308, 1.7603961, 1.3154977,\n                   1.3262832, 4.8867159, 2.7462887, 4.1852028, 2.1796338),\n  Weight_Category = c(\"2.5 to 5\", \"1.5 to 2.5\", \"< 1.5\", \"1.5 to 2.5\", \"1.5 to 2.5\",\n                      \"< 1.5\", \"2.5 to 5\", \"2.5 to 5\", \"1.5 to 2.5\", \"< 1.5\",\n                      \"< 1.5\", \"2.5 to 5\", \"2.5 to 5\", \"2.5 to 5\", \"1.5 to 2.5\"),\n  Loading_Cost = c(64300, 40680, 144640, 38790, 18750,\n                   11610, 97870, 36380, 69120, 70030,\n                   143740, 91150, 64990, 114230, 96240),\n  Transport_cost = c(3802097.2, 5037171.3, 7297102.2, 5952559.7, 3086494.5,\n                     8264855.3, 4021256.9, 889559.4, 2449208.3, 7188382.3,\n                     5831987.6, 974375.3, 4273915.6, 1047828.2, 4905804.6)\n)\n\n# Custom icon:\nwarehouse_icon <- makeIcon(\n  iconUrl = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/warehouse_icon.png\",\n  iconWidth = 30,\n  iconHeight = 30\n)\n\ndc_icon <- makeIcon(\n  iconUrl = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/distribution_center.png\",\n  iconWidth = 30,\n  iconHeight = 30\n)\n# Define a custom theme\nmy_theme <- bs_theme(\n  version = 5,\n  bootswatch = \"litera\",\n  primary = \"#3b5998\",\n  secondary = \"#5cb85c\",\n  success = \"#5cb85c\",\n  info = \"#5bc0de\",\n  warning = \"#f0ad4e\",\n  danger = \"#d9534f\"\n)\n\n# Define UI\nui <- page_fluid(\n  theme = my_theme,\n  \n  # Custom CSS for better visualization\n  tags$head(\n    tags$style(HTML(\"\n      .card-header {\n        background-color: #3b5998;\n        color: white;\n        font-weight: bold;\n      }\n      .nav-tabs .nav-link.active {\n        font-weight: bold;\n        color: #3b5998;\n        border-bottom: 2px solid #3b5998;\n      }\n      .nav-tabs .nav-link {\n        color: #6c757d;\n      }\n      .checkbox span {\n        font-weight: normal;\n      }\n      .checkbox input:checked + span {\n        font-weight: bold;\n        color: #3b5998;\n      }\n      .warehouse-selection {\n        border-left: 4px solid #3b5998;\n        padding-left: 10px;\n      }\n      .dataTables_wrapper {\n        padding: 10px;\n        border-radius: 5px;\n      }\n      .table thead th {\n        background-color: #e9ecef;\n      }\n      .leaflet-container {\n        border-radius: 8px;\n        box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n      }\n      .sankey-container {\n        border: 1px solid #dee2e6;\n        border-radius: 8px;\n        padding: 10px;\n        background-color: #f8f9fa;\n      }\n      .summary-stats {\n        background-color: #f8f9fa;\n        border-radius: 5px;\n        padding: 10px;\n        margin-bottom: 15px;\n        border-left: 4px solid #3b5998;\n      }\n    \"))\n  ),\n  \n  # Page header - simplified\n  card(\n    card_header(\n      tags$div(\n        class = \"d-flex align-items-center\",\n        tags$img(\n          src = \"https://raw.githubusercontent.com/Loccx78vn/Genetic-Algorithm/refs/heads/main/warehouse_icon.png\", \n          height = \"30px\", \n          style = \"margin-right: 10px;\"\n        ),\n        h3(\"Warehouse Distribution Dashboard\", class = \"m-0\")\n      )\n    ),\n    card_body(\n      \"This dashboard shows the optimal distribution of goods from warehouses to distribution centers.\"\n    )\n  ),\n  \n  layout_sidebar(\n    sidebar = sidebar(\n      title = \"Controls\",\n      width = 300,\n      bg = \"#f8f9fa\",\n      class = \"warehouse-selection\",\n      \n      h4(\"Warehouse Selection\", class = \"mb-3 text-primary\"),\n      \n      p(\"Select one or more warehouses to view their distribution data on the map and in the charts.\"),\n      \n      checkboxGroupInput(\n        inputId = \"warehouse\", \n        label = NULL, \n        choices = setNames(\n          paste(\"Warehouse\", 1:5),\n          paste(\"Warehouse\", 1:5, \"-\", warehouses$District, \",\", warehouses$Province)\n        ),\n        selected = paste(\"Warehouse\", 1)\n      ),\n      \n      hr(),\n      \n      tags$div(\n        class = \"alert alert-info\",\n        icon(\"info-circle\"), \n        \"Click on the map markers for detailed location information.\"\n      )\n    ),\n    \n    # Main content - restructured to put summary above map\n    tabsetPanel(\n      tabPanel(\n        title = \"Interactive Map\", \n        icon = icon(\"map\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased height\n          card_body(\n            # Summary stats placed above the map\n            tags$div(\n              class = \"summary-stats\",\n              uiOutput(\"summary_stats\")\n            ),\n            # Map with increased height\n            leafletOutput(\"map\", height = \"550px\") # Increased map height\n          )\n        )\n      ),\n      \n      tabPanel(\n        title = \"Cost Analysis\", \n        icon = icon(\"table\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased to match\n          card_header(\"Cost Table\"),\n          DTOutput(\"cost_table\")\n        )\n      ),\n      \n      tabPanel(\n        title = \"Flow Diagram\", \n        icon = icon(\"diagram-project\"),\n        card(\n          full_screen = TRUE,\n          height = \"650px\", # Increased to match\n          card_header(\"Distribution Flow Diagram\"),\n          tags$div(\n            class = \"sankey-container\",\n            uiOutput(\"sankey_diagram\")\n          )\n        )\n      )\n    )\n  )\n)\n\n# Define server logic\nserver <- function(input, output, session) {\n  \n  location <- reactive({\n    req(input$warehouse) \n    as.numeric(sub(\"Warehouse \", \"\", input$warehouse))\n  })\n  \n  # Create the leaflet map\n  output$map <- renderLeaflet({\n    req(location())\n    \n    # Color palette for routes\n    route_colors <- c(\"#FF5733\", \"#33A8FF\", \"#33FF57\", \"#D433FF\", \"#FFD133\")\n    \n    # Initialize the map\n    map <- leaflet() %>%\n      addTiles() %>%\n      addProviderTiles(providers$CartoDB.Positron) %>%\n      addMarkers(data = warehouses %>% filter(ID %in% location()), \n                 lat = ~Latitude, \n                 lng = ~Longitude, \n                 label = ~paste0(\"<strong> ID Warehouse: </strong> \", ID, \"<br/> \",\n                                 \"<strong> Province: </strong> \", Province, \"<br/> \",\n                                 \"<strong> District: </strong> \", District, \"<br/> \",\n                                 \"<strong> Address: </strong> \", Address, \"<br/> \") %>% \n                   lapply(htmltools::HTML),\n                 icon = warehouse_icon) %>%\n      addMarkers(data = distribution_centers, \n                 lat = ~Latitude, \n                 lng = ~Longitude, \n                 label = ~paste0(\"<strong> ID Distribution Center: </strong> \", ID, \"<br/> \",\n                                 \"<strong> Province: </strong> \", Province, \"<br/> \",\n                                 \"<strong> District: </strong> \", District, \"<br/> \",\n                                 \"<strong> Address: </strong> \", Address, \"<br/> \") %>% \n                   lapply(htmltools::HTML),\n                 icon = dc_icon)\n    \n    qty_data <- optimal_quantities[location(), , drop = FALSE]  \n    \n    # Add routes based on the optimal quantities with different colors\n    route_colors <- c(\"#FF5733\", \"#33A8FF\", \"#33FF57\", \"#D433FF\", \"#FFD133\")\n    line_weights <- c(2, 3, 4, 5, 6)  # Variable line weights based on quantity\n    \n    # Add routes based on the optimal quantities\n    for (i in seq_along(location())) {\n      wh_id <- location()[i]\n      wh_idx <- which(warehouses$ID == wh_id)\n      color_idx <- (wh_id - 1) %% length(route_colors) + 1\n      \n      for (j in 1:ncol(qty_data)) {\n        if (qty_data[i, j] > 0) {\n          route_start <- warehouses[warehouses$ID == wh_id, c(\"Longitude\", \"Latitude\")]\n          route_end <- distribution_centers[distribution_centers$ID == j, c(\"Longitude\", \"Latitude\")]\n          \n          # Calculate line weight based on quantity (normalized)\n          weight_multiplier <- qty_data[i, j] / max(optimal_quantities) * 5\n          weight <- max(2, min(6, weight_multiplier + 2))  # Scale between 2-6\n          \n          map <- map %>%\n            addPolylines(\n              lat = c(route_start$Latitude, route_end$Latitude),\n              lng = c(route_start$Longitude, route_end$Longitude),\n              color = route_colors[color_idx],\n              weight = weight,\n              opacity = 0.7,\n              label = paste0(\"Quantity: \", round(qty_data[i, j], 2)),\n              dashArray = \"5, 5\",\n              popup = paste0(\n                \"<strong>From:</strong> Warehouse \", wh_id,\n                \"<br><strong>To:</strong> Distribution Center \", j,\n                \"<br><strong>Quantity:</strong> \", round(qty_data[i, j], 2)\n              )\n            )\n        }\n      }\n    }\n    \n    map  # Return the modified map\n  })\n  \n  # Render the cost table\n  output$cost_table <- renderDT({\n    req(location())\n    \n    cost_data <- result %>% \n      filter(Warehouse %in% paste(\"WH\", location())) %>% \n      select(c(Warehouse, DC, Loading_Cost, Transport_cost))\n    \n    # Add a Total Cost column\n    cost_data$Total_Cost <- cost_data$Loading_Cost + cost_data$Transport_cost\n    \n    # Format currency values\n    cost_data$Loading_Cost <- formatC(cost_data$Loading_Cost, format=\"f\", digits=0, big.mark=\",\")\n    cost_data$Transport_cost <- formatC(cost_data$Transport_cost, format=\"f\", digits=0, big.mark=\",\")\n    cost_data$Total_Cost <- formatC(cost_data$Total_Cost, format=\"f\", digits=0, big.mark=\",\")\n    \n    datatable(cost_data,\n              options = list(\n                pageLength = 10,\n                dom = 'Bfrtip',\n                buttons = c('copy', 'csv', 'excel'),\n                initComplete = JS(\n                  \"function(settings, json) {\",\n                  \"$(this.api().table().header()).css({'background-color': '#3b5998', 'color': 'white'});\",\n                  \"}\"\n                ),\n                columnDefs = list(\n                  list(className = 'dt-center', targets = \"_all\")\n                )\n              ),\n              rownames = FALSE,\n              class = 'compact stripe hover') %>%\n      formatStyle(\n        'Warehouse',\n        backgroundColor = styleEqual(\n          paste(\"WH\", 1:5), \n          c('#FFC3A0', '#A0D2FF', '#C8FFB0', '#D5A0FF', '#FFF0A0')\n        )\n      ) %>%\n      formatStyle(\n        'DC',\n        backgroundColor = styleEqual(\n          c(\"DC 1\", \"DC 2\", \"DC 3\"), \n          c('#FFDDC3', '#C3E5FF', '#DDFFC3')\n        )\n      )\n  })\n  \n  \n  # Create and render the Sankey diagram\n  selected_indices <- reactive({\n    as.numeric(sub(\"Warehouse \", \"\", input$warehouse))\n  })\n  \n  # Filter data based on selected warehouses\n  filtered_data <- reactive({\n    result %>%\n      filter(Warehouse %in% paste(\"WH\",input$warehouse))\n  })\n\n  # Create and render the Sankey diagram\n  output$sankey_diagram <- renderUI({\n    req(length(selected_indices()) > 0)\n    \n    # Create links data frame\n    links <- data.frame()\n    \n    # Add links for each selected warehouse\n    for (i in 1:length(selected_indices())) {\n      wh_idx <- selected_indices()[i]\n      wh_data <- optimal_quantities[wh_idx, , drop = FALSE]\n      \n      # Add links for each DC\n      for (j in 1:ncol(wh_data)) {\n        if (wh_data[1, j] > 0) {\n          links <- rbind(links, data.frame(\n            source = i - 1,  # Use index in selected warehouses (0-based)\n            target = length(selected_indices()) + j - 1,  # DCs come after warehouses\n            value = wh_data[1, j]\n          ))\n        }\n      }\n    }\n    \n    # Only proceed if we have links\n    req(nrow(links) > 0)\n    \n    # Create nodes data frame\n    nodes <- data.frame(\n      name = c(paste(\"Warehouse\", selected_indices()), paste(\"DC\", 1:3))\n    )\n    \n    # Create the Sankey network\n    sankey <- sankeyNetwork(\n      Links = links, \n      Nodes = nodes, \n      Source = \"source\", \n      Target = \"target\", \n      Value = \"value\",\n      NodeID = \"name\",\n      height = 500,  \n      width = 800,\n      fontSize = 12,\n      nodeWidth = 20,\n      sinksRight = TRUE\n    )\n    \n    # Customize tooltips and add click functionality to show a value panel\n    sankey <- htmlwidgets::onRender(sankey, \"\n    function(el, x) {\n      // Create a div for the value panel\n      var valuePanel = d3.select('body').append('div')\n        .attr('class', 'value-panel')\n        .style('position', 'absolute')\n        .style('padding', '8px')\n        .style('background', 'lightgray')\n        .style('border', '1px solid gray')\n        .style('border-radius', '4px')\n        .style('opacity', 0);  // Start hidden\n\n      // Append title for tooltips on hover\n      d3.selectAll('.link')\n        .append('title')\n        .text(function(d) { return 'Quantity: ' + d.value.toFixed(2); });  // Show value on hover\n\n      // Add click event to show the value panel\n      d3.selectAll('.link')\n        .on('click', function(event, d) {\n          // Ensure we get the correct value\n          var value = d3.select(this).datum().value;\n          var source = nodes.name[d.source.index];\n          var target = nodes.name[d.target.index];\n\n          // Position the value panel near the mouse cursor\n          valuePanel\n            .style('left', (event.pageX + 5) + 'px')\n            .style('top', (event.pageY + 5) + 'px')\n            .style('opacity', 1)  // Make it visible\n            .html('From: ' + source + '<br>To: ' + target + '<br>Quantity: ' + value.toFixed(2));  // Set the text with details\n\n          // Hide the panel after a delay\n          setTimeout(function() {\n            valuePanel.style('opacity', 0);\n          }, 3000);  // Change the delay as needed\n        });\n    }\n    \")\n    \n    # Add title and caption\n    tagList(\n      sankey,\n      tags$p(style = \"font-size: 12px; text-align: right;\", \n             \"A wider arrow indicates that a larger quantity is being sent from that warehouse to a distribution center.\")\n    )\n  })\n  \n  # Add a summary statistics output at the bottom of the map tab\n  output$summary_stats <- renderUI({\n    req(location())\n    \n    selected_data <- result %>% \n      filter(Warehouse %in% paste(\"WH\", location()))\n    \n    total_loading <- sum(selected_data$Loading_Cost)\n    total_transport <- sum(selected_data$Transport_cost)\n    total_weight <- sum(selected_data$Total_Weight)\n    \n    div(\n      class = \"mt-3 p-3 bg-light rounded\",\n      h4(\"Summary Statistics\", class = \"text-primary mb-3\"),\n      div(class = \"row\",\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-primary mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Weight\"),\n                      h3(class = \"card-text\", paste0(round(total_weight, 2), \" tons\"))\n                  )\n              )\n          ),\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-success mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Loading Cost\"),\n                      h3(class = \"card-text\", paste0(\"₫\", formatC(total_loading, format=\"f\", digits=0, big.mark=\",\")))\n                  )\n              )\n          ),\n          div(class = \"col-md-4\",\n              div(class = \"card text-white bg-info mb-3\",\n                  div(class = \"card-body\",\n                      h5(class = \"card-title\", \"Total Transport Cost\"),\n                      h3(class = \"card-text\", paste0(\"₫\", formatC(total_transport, format=\"f\", digits=0, big.mark=\",\")))\n                  )\n              )\n          )\n      )\n    )\n  })\n}\n\n# Run the application \nshinyApp(ui = ui, server = server)\n```\n:::\n\nBạn có thể thấy với **dashboard** như vậy, ta có thể xem được nhiều thông tin hơn như:\n\n-   Vị trí cụ thể của từng *WH* và *DC* cũng như là các tuyến đường dự kiến bằng các đường thẳng minh họa. (Xem **Map tab**)\n\n-   Thông tin về chi phí *Loading cost* và *Transporation cost* cũng như lượng hàng cần vận chuyển cho từng nhà kho. (Xem **Table and Sankey tab**)\n\nBạn có thể xem cho 1 hoặc nhiều nhà kho bằng cách *click* trên thanh **Filter**. Ngoài ra, đặc biệt với **Sankey chart**, bạn cần giữ hoặc *click* chuột vào tuyến để xem được số lượng hàng.\n\nTuy rất thích R nhưng mình vẫn không thích xây dựng dashboard bằng R lắm vì quá nặng về code và không hiệu quả về thời gian, nguồn lực. Các tools khác mình ưu tiên hơn như **Power BI**, **Tableau** hoặc các **BIs** mà công ty bạn sử dụng trong công việc hằng ngày.\n\n## Mô hình MILP:\n\nTiếp theo ta sẽ chuyển sang thuật toán tuyến tính mới là mô hình MILP.\n\n### Giới thiệu sơ lược:\n\n**MILP (Mixed Integer Linear Programming)** là một phương pháp tối ưu hóa được sử dụng trong các bài toán lập kế hoạch, phân bổ tài nguyên, và quyết định trong các lĩnh vực như logistics, sản xuất, tài chính, và nhiều lĩnh vực khác. MILP là một phần mở rộng của lập trình tuyến tính (Linear Programming - LP), trong đó có các biến là số nguyên (integer variables) bên cạnh các biến liên tục (continuous variables).\n\nTrong đó, cấu trúc của một bài toán MILP bao gồm:\n\n1.  **Hàm mục tiêu**: Là một hàm tuyến tính mà bạn muốn tối ưu hóa (tối đa hóa hoặc tối thiểu hóa).\n\n    $$\n    \\text{Maximize or Minimize } Z = c_1x_1 + c_2x_2 + \\ldots + c_nx_n\n    $$\n\n2.  **Ràng buộc**: Bao gồm các điều kiện tuyến tính mà các biến phải thỏa mãn.\n\n    $$\n    a_{11}x_1 + a_{12}x_2 + \\ldots + a_{1n}x_n \\leq b_1\n    $$\n\n    $$\n    a_{21}x_1 + a_{22}x_2 + \\ldots + a_{2n}x_n \\leq b_2\n    $$\n\n    ... và nhiều ràng buộc khác.\n\n3.  **Biến quyết định**: Các biến trong bài toán có thể là:\n\n    -   Biến liên tục: Có thể nhận mọi giá trị thực (ví dụ: số lượng sản phẩm).\n    -   Biến nguyên: Chỉ nhận giá trị nguyên (ví dụ: số lượng xe tải).\n    -   Biến nhị phân: Chỉ nhận giá trị 0 hoặc 1 (ví dụ: có hoặc không sử dụng một nhà máy).\n\nMô hình **MILP** là một công cụ mạnh mẽ cho việc tối ưu hóa trong nhiều lĩnh vực khác nhau. Với khả năng kết hợp giữa các biến liên tục và số nguyên, MILP có thể giải quyết nhiều bài toán phức tạp mà các phương pháp tối ưu hóa khác không thể thực hiện hiệu quả. Các ứng dụng phổ biến bao gồm:\n\n-   **Quản lý chuỗi cung ứng**: Tối ưu hóa việc phân phối hàng hóa từ các kho đến các khách hàng.\n-   **Lập kế hoạch sản xuất**: Xác định số lượng sản phẩm cần sản xuất để tối đa hóa lợi nhuận hoặc giảm chi phí.\n-   **Tối ưu hóa lịch trình**: Lập lịch cho nhân viên, máy móc, hoặc tài nguyên để tối ưu hóa hiệu suất.\n-   **Quy hoạch đô thị**: Tối ưu hóa việc sử dụng đất và tài nguyên trong quy hoạch thành phố.\n\nTrong R có các thư viện như `lpSolve`, `ompr`, và `ROI` có thể được sử dụng để giải quyết các bài toán MILP.\n\n### Ví dụ về mô hình MILP:\n\nGỉa sử ta có bài toán về vấn đề **Transshipment** có yêu cầu là tìm ra phương án vận tải tối ưu nhất để vận chuyển hàng hóa từ nhà máy (**Factory**) thông qua **Crossdocking** và đến được **Distribution Center** với mục tiêu là đạt **chi phí thấp nhất**.\n\n```{=html}\n<div style=\"text-align: center; margin-bottom: 20px;\">\n  <img src=\"img/transshipment.png\" style=\"max-width: 100%; height: auto; display: block; margin: 0 auto;\">\n  \n  <!-- Picture Name -->\n  <div style=\"text-align: left; margin-top: 10px;\">\n    Hình 5: Vấn đề Transshipment\n  </div>\n  \n  <!-- Source Link -->\n  <div style=\"text-align: right; font-style: italic; margin-top: 5px;\">\n    Source: <a href=\"https://posit.co/download/rstudio-desktop/\">Rstudio</a>\n  </div>\n</div>\n```\n\nVì bài toán này thuộc dạng tuyến tính nên phương pháp MILP sẽ làm tốt hơn nhiều so với thuật toán GA bên trên. Kết quả được trình bày bên dưới đây\n\n```{r}\n#| warning: false\n#| message: false\n#| output: false\n#| fig-cap: \"Biểu đồ 4: Kết quả từ mô hình MILP\"\nlibrary(ompr)\nlibrary(ompr.roi)\nlibrary(ROI.plugin.glpk)\n#Input:\nSupply <-c(200,300,100,150,220)\nDemand <-c(150,100,110,200,180)\nDC<-2\nm<-length(Supply)\nn<-length(Demand)\n\nCost_CD<-read.table(text = \n                    \"CD1 CD2\n                     30 50\n                     23 66\n                     35 14\n                     70 12\n                     65 70\",header = T)\nCost_DC<-read.table(text = \n                      \"DC1 DC2 DC3 DC4 DC5\n                       12 25 22 40 41\n                       65 22 23 12 15\",header = T)\n\n#MILP model from the \nmodel5 <- MIPModel() %>%\n  # Add variable\n  add_variable(x[i, j], i = 1:m, j = 1:DC) %>%\n  add_variable(y[j, k], j = 1:DC, k = 1:n) %>%\n  # minimize the cost of transshipment:\n  set_objective(sum_expr(x[i, j]*Cost_CD[i, j],i = 1:m, j = 1:DC)+ sum_expr(y[j, k]*Cost_DC[j, k], k = 1:n, j = 1:DC),\"min\") %>%\n  add_constraint(sum_expr(y[j, k], j = 1:DC) >= Demand[k], k = 1:n) %>%\n  # The amount of inventory in Crossdocking is smaller than production goods\n  add_constraint(sum_expr(x[i, j], j = 1:DC) <= Supply[i], i = 1:m) %>% \n  # The amount of is bigger than demand in DC\n  add_constraint(sum_expr(x[i, j], i = 1:m) - sum_expr(y[j, k], k = 1:n) >= 0,j = 1:DC) %>%\n  add_constraint(x[i, j] >= 0, j = 1:DC, i = 1:m)%>% \n  add_constraint(y[j, k] >= 0, j = 1:DC, k = 1:n)%>% \n  #Solve the model:\n  solve_model(with_ROI(solver = \"glpk\", verbose = TRUE))\n```\n\n```{r}\n#| layout: [[50,50]]\n#| warning: false\n#| message: false\n#| echo: false\n\n## Table:\nsolution <- get_solution(model5, x[i, j]) %>% \n     filter(value > 0)\n\nlibrary(gt)\nlibrary(dplyr)\nlibrary(scales)  \n\n# Assuming `solution` contains the results of x[i, j]\n# Transform the solution into a tidy format for the table\ntable_data <- solution %>%\n  rename(Manufacturer = i, DC = j, Flow = value) %>%\n  mutate(Manufacturer = paste(\"Manufacturer\", Manufacturer),\n         DC = paste(\"DC\", DC)) %>% \n  select(-variable)\n\n# Create a gt table\ntable_data %>%\n  gt() %>%\n  tab_header(\n    title = md(\"**Transshipment flows from Manufacturers to Distribution Centers**\")\n  ) %>%\n  cols_label(\n    Manufacturer = md(\"**Manufacturer**\"),\n    DC = md(\"**Distribution Center**\"),\n    Flow = md(\"**Flow Amount**\")) %>%\n  fmt_number(\n    columns = c(Flow),\n    decimals = 2\n  ) %>%\n  data_color(\n    columns = c(Flow),  # Use c() instead of vars()\n    colors = scales::col_numeric(palette = c(\"#2ca02c\",\"#ff7f0e\"), domain = NULL)\n  ) %>%\n  cols_align(\n    align = \"center\",\n    columns = everything()  # Applies to all columns\n  ) %>%\n  tab_options(\n    table.width = pct(100)\n  ) %>% \n  gt_theme_espn()\n\n## Barchart:\n\nlibrary(ggplot2)\nplot_data <- solution %>%\n  rename(Manufacter= i, DC = j, Flow = value) %>%\n  mutate(Manufacter = paste(\"Manufacter\", Manufacter),\n         DC = paste(\"DC\", DC))\n\n# Create a plot\nggplot(plot_data, aes(x = Manufacter, y = Flow, fill = DC)) +\n  geom_bar(stat = \"identity\", position = \"dodge\") +\n  theme_minimal() +\n  labs(title = \"\",\n       x = \"Manufacters\",\n       y = \"Flow Amount\",\n       fill = \"Distribution Centers\") +\n  theme(text = element_text(size = 12),\n        axis.text.x = element_text(angle = 45, hjust = 1)) +\n  scale_fill_brewer(palette = \"Set2\")\n```\n\nNhư vậy, chúng ta đã được học về thuật toán Genetic và mô hình MILP cũng như cách thực hiện trong Rstudio.\n\nNếu bạn có câu hỏi hay thắc mắc nào, đừng ngần ngại liên hệ với mình qua Gmail. Bên cạnh đó, nếu bạn muốn xem lại các bài viết trước đây của mình, hãy nhấn vào hai nút dưới đây để truy cập trang **Rpubs** hoặc mã nguồn trên **Github**. Rất vui được đồng hành cùng bạn, hẹn gặp lại! 😄😄😄\n\n```{=html}\n<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Contact Me</title>\n    <link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css\">\n    <link rel=\"stylesheet\" href=\"https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/svgs/rstudio.svg\">\n    <style>\n        body { font-family: Arial, sans-serif; background-color: $secondary-color; }\n        .container { max-width: 400px; margin: auto; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1); }\n        label { display: block; margin: 10px 0 5px; }\n        input[type=\"email\"] { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; }\n        .github-button, .rpubs-button { margin-top: 20px; text-align: center; }\n        .github-button button, .rpubs-button button { background-color: #333; color: white; border: none; padding: 10px; cursor: pointer; border-radius: 4px; width: 100%; }\n        .github-button button:hover, .rpubs-button button:hover { background-color: #555; }\n        .rpubs-button button { background-color: #75AADB; }\n        .rpubs-button button:hover { background-color: #5A9BC2; }\n        .rpubs-icon { margin-right: 5px; width: 20px; vertical-align: middle; filter: brightness(0) invert(1); }\n        .error-message { color: red; font-size: 0.9em; margin-top: 5px; }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <h2>Contact Me</h2>\n        <form id=\"emailForm\">\n            <label for=\"email\">Your Email:</label>\n            <input type=\"email\" id=\"email\" name=\"email\" required aria-label=\"Email Address\">\n            <div class=\"error-message\" id=\"error-message\" style=\"display: none;\">Please enter a valid email address.</div>\n            <button type=\"submit\">Send Email</button>\n        </form>\n        <div class=\"github-button\">\n            <button>\n                <a href=\"https://github.com/Loccx78vn\" target=\"_blank\" style=\"color: white; text-decoration: none;\">\n                    <i class=\"fab fa-github\"></i> View Code on GitHub\n                </a>\n            </button>\n        </div>\n        <div class=\"rpubs-button\">\n            <button>\n                <a href=\"https://rpubs.com/loccx\" target=\"_blank\" style=\"color: white; text-decoration: none;\">\n                    <img src=\"https://cdn.jsdelivr.net/npm/simple-icons@v6.0.0/icons/rstudio.svg\" alt=\"RStudio icon\" class=\"rpubs-icon\"> Visit my RPubs\n                </a>\n            </button>\n        </div>\n    </div>\n\n    <script>\n        document.getElementById('emailForm').addEventListener('submit', function(event) {\n            event.preventDefault(); // Prevent default form submission\n            const emailInput = document.getElementById('email');\n            const email = emailInput.value;\n            const errorMessage = document.getElementById('error-message');\n\n            // Simple email validation regex\n            const emailPattern = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\n\n            if (emailPattern.test(email)) {\n                errorMessage.style.display = 'none'; // Hide error message\n                const yourEmail = 'loccaoxuan103@gmail.com'; // Your email\n                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=${yourEmail}&su=Help%20Request%20from%20${encodeURIComponent(email)}`;\n                window.open(gmailLink, '_blank'); // Open in new tab\n            } else {\n                errorMessage.style.display = 'block'; // Show error message\n            }\n        });\n    </script>\n</body>\n</html>\n```\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":false,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"knitr"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":true,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","toc":true,"include-in-header":["toc-filter.html",{"text":"<link rel=\"stylesheet\" href=\"https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css\">\n"}],"number-sections":true,"filters":["quarto-ext/shinylive"],"output-file":"GA.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.7.31","theme":"theme.scss","title":"Genetic Algorithms in R","subtitle":"Việt Nam, 2024","categories":["SupplyChainManagement","Logistics","Genetic Algorithm"],"description":"Đây là bài viết của tôi về cách sử dụng R trong ứng dụng Genetic Algorithm trong Supply Chain","bibliography":["references.bib"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}