---
title: "MILP model in R"
subtitle: "Viá»‡t Nam, 2024"
categories: ["MILP model", "Logistics","Optimizing Supply Chain"]
description: "ÄÃ¢y lÃ  bÃ i viáº¿t cá»§a tÃ´i vá» cÃ¡ch sá»­ dá»¥ng R trong á»©ng dá»¥ng Genetic Algorithm trong Supply Chain"
number-sections: true
format: 
  html:
    code-fold: true
    code-tools: true
crossref:
  labels: alpha a        
  subref-labels: roman
bibliography: references.bib
---

```{r}
#| warning: false
#| message: false
#| echo: false
#Call packages
pacman::p_load(rio,
               here,
               janitor,
               tidyverse,
               dplyr,
               magrittr,
               ggplot2,
               gt,
               gtExtras)
```

## MÃ´ hÃ¬nh MILP:

Tiáº¿p theo ta sáº½ chuyá»ƒn sang thuáº­t toÃ¡n tuyáº¿n tÃ­nh má»›i lÃ  mÃ´ hÃ¬nh MILP.

### Giá»›i thiá»‡u sÆ¡ lÆ°á»£c:

**MILP (Mixed Integer Linear Programming)** lÃ  má»™t phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a Ä‘Æ°á»£c sá»­ dá»¥ng trong cÃ¡c bÃ i toÃ¡n láº­p káº¿ hoáº¡ch, phÃ¢n bá»• tÃ i nguyÃªn, vÃ  quyáº¿t Ä‘á»‹nh trong cÃ¡c lÄ©nh vá»±c nhÆ° logistics, sáº£n xuáº¥t, tÃ i chÃ­nh, vÃ  nhiá»u lÄ©nh vá»±c khÃ¡c. MILP lÃ  má»™t pháº§n má»Ÿ rá»™ng cá»§a láº­p trÃ¬nh tuyáº¿n tÃ­nh (Linear Programming - LP), trong Ä‘Ã³ cÃ³ cÃ¡c biáº¿n lÃ  sá»‘ nguyÃªn (integer variables) bÃªn cáº¡nh cÃ¡c biáº¿n liÃªn tá»¥c (continuous variables).

Trong Ä‘Ã³, cáº¥u trÃºc cá»§a má»™t bÃ i toÃ¡n MILP bao gá»“m:

1.  **HÃ m má»¥c tiÃªu**: LÃ  má»™t hÃ m tuyáº¿n tÃ­nh mÃ  báº¡n muá»‘n tá»‘i Æ°u hÃ³a (tá»‘i Ä‘a hÃ³a hoáº·c tá»‘i thiá»ƒu hÃ³a).

    $$
    \text{Maximize or Minimize } Z = c_1x_1 + c_2x_2 + \ldots + c_nx_n
    $$

2.  **RÃ ng buá»™c**: Bao gá»“m cÃ¡c Ä‘iá»u kiá»‡n tuyáº¿n tÃ­nh mÃ  cÃ¡c biáº¿n pháº£i thá»a mÃ£n.

    $$
    a_{11}x_1 + a_{12}x_2 + \ldots + a_{1n}x_n \leq b_1
    $$

    $$
    a_{21}x_1 + a_{22}x_2 + \ldots + a_{2n}x_n \leq b_2
    $$

    ... vÃ  nhiá»u rÃ ng buá»™c khÃ¡c.

3.  **Biáº¿n quyáº¿t Ä‘á»‹nh**: CÃ¡c biáº¿n trong bÃ i toÃ¡n cÃ³ thá»ƒ lÃ :

    -   Biáº¿n liÃªn tá»¥c: CÃ³ thá»ƒ nháº­n má»i giÃ¡ trá»‹ thá»±c (vÃ­ dá»¥: sá»‘ lÆ°á»£ng sáº£n pháº©m).
    -   Biáº¿n nguyÃªn: Chá»‰ nháº­n giÃ¡ trá»‹ nguyÃªn (vÃ­ dá»¥: sá»‘ lÆ°á»£ng xe táº£i).
    -   Biáº¿n nhá»‹ phÃ¢n: Chá»‰ nháº­n giÃ¡ trá»‹ 0 hoáº·c 1 (vÃ­ dá»¥: cÃ³ hoáº·c khÃ´ng sá»­ dá»¥ng má»™t nhÃ  mÃ¡y).

MÃ´ hÃ¬nh **MILP** lÃ  má»™t cÃ´ng cá»¥ máº¡nh máº½ cho viá»‡c tá»‘i Æ°u hÃ³a trong nhiá»u lÄ©nh vá»±c khÃ¡c nhau. Vá»›i kháº£ nÄƒng káº¿t há»£p giá»¯a cÃ¡c biáº¿n liÃªn tá»¥c vÃ  sá»‘ nguyÃªn, MILP cÃ³ thá»ƒ giáº£i quyáº¿t nhiá»u bÃ i toÃ¡n phá»©c táº¡p mÃ  cÃ¡c phÆ°Æ¡ng phÃ¡p tá»‘i Æ°u hÃ³a khÃ¡c khÃ´ng thá»ƒ thá»±c hiá»‡n hiá»‡u quáº£. CÃ¡c á»©ng dá»¥ng phá»• biáº¿n bao gá»“m:

-   **Quáº£n lÃ½ chuá»—i cung á»©ng**: Tá»‘i Æ°u hÃ³a viá»‡c phÃ¢n phá»‘i hÃ ng hÃ³a tá»« cÃ¡c kho Ä‘áº¿n cÃ¡c khÃ¡ch hÃ ng.
-   **Láº­p káº¿ hoáº¡ch sáº£n xuáº¥t**: XÃ¡c Ä‘á»‹nh sá»‘ lÆ°á»£ng sáº£n pháº©m cáº§n sáº£n xuáº¥t Ä‘á»ƒ tá»‘i Ä‘a hÃ³a lá»£i nhuáº­n hoáº·c giáº£m chi phÃ­.
-   **Tá»‘i Æ°u hÃ³a lá»‹ch trÃ¬nh**: Láº­p lá»‹ch cho nhÃ¢n viÃªn, mÃ¡y mÃ³c, hoáº·c tÃ i nguyÃªn Ä‘á»ƒ tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t.
-   **Quy hoáº¡ch Ä‘Ã´ thá»‹**: Tá»‘i Æ°u hÃ³a viá»‡c sá»­ dá»¥ng Ä‘áº¥t vÃ  tÃ i nguyÃªn trong quy hoáº¡ch thÃ nh phá»‘.

Trong R cÃ³ cÃ¡c thÆ° viá»‡n nhÆ° `lpSolve`, `ompr`, vÃ  `ROI` cÃ³ thá»ƒ Ä‘Æ°á»£c sá»­ dá»¥ng Ä‘á»ƒ giáº£i quyáº¿t cÃ¡c bÃ i toÃ¡n MILP.

### VÃ­ dá»¥ vá» mÃ´ hÃ¬nh MILP:

Gá»‰a sá»­ ta cÃ³ bÃ i toÃ¡n vá» váº¥n Ä‘á» **Transshipment** cÃ³ yÃªu cáº§u lÃ  tÃ¬m ra phÆ°Æ¡ng Ã¡n váº­n táº£i tá»‘i Æ°u nháº¥t Ä‘á»ƒ váº­n chuyá»ƒn hÃ ng hÃ³a tá»« nhÃ  mÃ¡y (**Factory**) thÃ´ng qua **Crossdocking** vÃ  Ä‘áº¿n Ä‘Æ°á»£c **Distribution Center** vá»›i má»¥c tiÃªu lÃ  Ä‘áº¡t **chi phÃ­ tháº¥p nháº¥t**.

```{=html}
<div style="text-align: center; margin-bottom: 20px;">
  <img src="img/transshipment.png" style="max-width: 100%; height: auto; display: block; margin: 0 auto;">
  
  <!-- Picture Name -->
  <div style="text-align: left; margin-top: 10px;">
    HÃ¬nh 5: Váº¥n Ä‘á» Transshipment
  </div>
  
  <!-- Source Link -->
  <div style="text-align: right; font-style: italic; margin-top: 5px;">
    Source: <a href="https://posit.co/download/rstudio-desktop/">Rstudio</a>
  </div>
</div>
```

VÃ¬ bÃ i toÃ¡n nÃ y thuá»™c dáº¡ng tuyáº¿n tÃ­nh nÃªn phÆ°Æ¡ng phÃ¡p MILP sáº½ lÃ m tá»‘t hÆ¡n nhiá»u so vá»›i thuáº­t toÃ¡n GA bÃªn trÃªn. Káº¿t quáº£ Ä‘Æ°á»£c trÃ¬nh bÃ y bÃªn dÆ°á»›i Ä‘Ã¢y

```{r}
#| warning: false
#| message: false
#| output: false
#| fig-cap: "Biá»ƒu Ä‘á»“ 4: Káº¿t quáº£ tá»« mÃ´ hÃ¬nh MILP"
library(ompr)
library(ompr.roi)
library(ROI.plugin.glpk)
#Input:
Supply <-c(200,300,100,150,220)
Demand <-c(150,100,110,200,180)
DC<-2
m<-length(Supply)
n<-length(Demand)

Cost_CD<-read.table(text = 
                    "CD1 CD2
                     30 50
                     23 66
                     35 14
                     70 12
                     65 70",header = T)
Cost_DC<-read.table(text = 
                      "DC1 DC2 DC3 DC4 DC5
                       12 25 22 40 41
                       65 22 23 12 15",header = T)

#MILP model from the 
model5 <- MIPModel() %>%
  # Add variable
  add_variable(x[i, j], i = 1:m, j = 1:DC) %>%
  add_variable(y[j, k], j = 1:DC, k = 1:n) %>%
  # minimize the cost of transshipment:
  set_objective(sum_expr(x[i, j]*Cost_CD[i, j],i = 1:m, j = 1:DC)+ sum_expr(y[j, k]*Cost_DC[j, k], k = 1:n, j = 1:DC),"min") %>%
  add_constraint(sum_expr(y[j, k], j = 1:DC) >= Demand[k], k = 1:n) %>%
  # The amount of inventory in Crossdocking is smaller than production goods
  add_constraint(sum_expr(x[i, j], j = 1:DC) <= Supply[i], i = 1:m) %>% 
  # The amount of is bigger than demand in DC
  add_constraint(sum_expr(x[i, j], i = 1:m) - sum_expr(y[j, k], k = 1:n) >= 0,j = 1:DC) %>%
  add_constraint(x[i, j] >= 0, j = 1:DC, i = 1:m)%>% 
  add_constraint(y[j, k] >= 0, j = 1:DC, k = 1:n)%>% 
  #Solve the model:
  solve_model(with_ROI(solver = "glpk", verbose = TRUE))
```

```{r}
#| layout: [[50,50]]
#| warning: false
#| message: false
#| echo: false

## Table:
solution <- get_solution(model5, x[i, j]) %>% 
     filter(value > 0)

library(gt)
library(dplyr)
library(scales)  

# Assuming `solution` contains the results of x[i, j]
# Transform the solution into a tidy format for the table
table_data <- solution %>%
  rename(Manufacturer = i, DC = j, Flow = value) %>%
  mutate(Manufacturer = paste("Manufacturer", Manufacturer),
         DC = paste("DC", DC)) %>% 
  select(-variable)

# Create a gt table
table_data %>%
  gt() %>%
  tab_header(
    title = md("**Transshipment flows from Manufacturers to Distribution Centers**")
  ) %>%
  cols_label(
    Manufacturer = md("**Manufacturer**"),
    DC = md("**Distribution Center**"),
    Flow = md("**Flow Amount**")) %>%
  fmt_number(
    columns = c(Flow),
    decimals = 2
  ) %>%
  data_color(
    columns = c(Flow),  # Use c() instead of vars()
    colors = scales::col_numeric(palette = c("#2ca02c","#ff7f0e"), domain = NULL)
  ) %>%
  cols_align(
    align = "center",
    columns = everything()  # Applies to all columns
  ) %>%
  tab_options(
    table.width = pct(100)
  ) %>% 
  gt_theme_espn()

## Barchart:

library(ggplot2)
plot_data <- solution %>%
  rename(Manufacter= i, DC = j, Flow = value) %>%
  mutate(Manufacter = paste("Manufacter", Manufacter),
         DC = paste("DC", DC))

# Create a plot
ggplot(plot_data, aes(x = Manufacter, y = Flow, fill = DC)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "",
       x = "Manufacters",
       y = "Flow Amount",
       fill = "Distribution Centers") +
  theme(text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_fill_brewer(palette = "Set2")
```

NhÆ° váº­y, chÃºng ta Ä‘Ã£ Ä‘Æ°á»£c há»c vá» thuáº­t toÃ¡n Genetic vÃ  mÃ´ hÃ¬nh MILP cÅ©ng nhÆ° cÃ¡ch thá»±c hiá»‡n trong Rstudio.

Náº¿u báº¡n cÃ³ cÃ¢u há»i hay tháº¯c máº¯c nÃ o, Ä‘á»«ng ngáº§n ngáº¡i liÃªn há»‡ vá»›i mÃ¬nh qua Gmail. BÃªn cáº¡nh Ä‘Ã³, náº¿u báº¡n muá»‘n xem láº¡i cÃ¡c bÃ i viáº¿t trÆ°á»›c Ä‘Ã¢y cá»§a mÃ¬nh, hÃ£y nháº¥n vÃ o hai nÃºt dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ truy cáº­p trang **Rpubs** hoáº·c mÃ£ nguá»“n trÃªn **Github**. Ráº¥t vui Ä‘Æ°á»£c Ä‘á»“ng hÃ nh cÃ¹ng báº¡n, háº¹n gáº·p láº¡i! ğŸ˜„ğŸ˜„ğŸ˜„


```{r}
#| echo: false
#| message: false
#| warning: false
htmltools::includeHTML("message.html")
```